import{i as De,q as Ne,n as Ee,r as u,a as A,u as i,j as e,V as we,k as oe,f as p,A as ye,C as E,b as w,c as y,e as S,h as Se,s as Ce,l as Ie,d as ie,M as de}from"./index-BZTLDehx.js";import{u as ke}from"./usePortalPath-CsSYngOC.js";import{B as Ae}from"./badge-CRUAWryU.js";import{S as Te,a as Re,b as Le,c as We,d as Pe}from"./select-BqvIpqbY.js";import{D as Oe,a as Ve,b as _e,c as $e,d as Me,f as Ue}from"./dialog-CdN4X8z7.js";import{f as ce}from"./currencyUtils-CJd_f-r_.js";import{f as me}from"./format-B3XKS-z2.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=De("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]),Be={RECEIVED:"received",WORK_STARTED:"workStarted",COMPLETED:"completed",DELIVERED:"delivered"};function Je(d){return!d||typeof d!="string"?"":d.replace(/\D/g,"").trim()}function Fe(d,{name:C="",vehicleNumber:g="",token:s="",beforeImagesLink:T="",afterImagesLink:r=""}){return d?d.replace(/\{\{name\}\}/g,String(C)).replace(/\{\{vehicleNumber\}\}/g,String(g)).replace(/\{\{token\}\}/g,String(s)).replace(/\{\{beforeImagesLink\}\}/g,String(T)).replace(/\{\{afterImagesLink\}\}/g,String(r)):""}const Ge={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},qe=[{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}];function as(){var F,G,q,z,H,Y,Q,X,Z,ee,se,ae,te,re,le;const{id:d}=Ne(),C=Ee(),g=ke(),[s,T]=u.useState(null),[r,_]=u.useState(null),[ue,pe]=u.useState(!0),[b,$]=u.useState(!1),[I,R]=u.useState(""),[he,f]=u.useState(!1),[j,L]=u.useState([]),[M,U]=u.useState(!1);u.useEffect(()=>{d&&K()},[d]);const K=async()=>{var a,t,l;try{const[n,o]=await Promise.all([A.get(`/admin/jobs/${d}`),A.get("/admin/settings").catch(()=>({data:{}}))]);n.data.success?(T(n.data.job),R(n.data.job.status)):(i.error("Failed to load job"),C(`${g}/jobs`)),(a=o==null?void 0:o.data)!=null&&a.success&&o.data.settings?_(o.data.settings):_({})}catch(n){i.error(((l=(t=n.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to load job"),C(`${g}/jobs`)}finally{pe(!1)}},fe=()=>K(),W=async(a,t=null)=>{var n,o;const l=a??I;if(!(!l||l===s.status)){if(l==="DELIVERED"&&(!t||t.length<2)){f(!0);return}$(!0);try{const c={status:l};t!=null&&t.length&&(c.afterImages=t),(await A.patch(`/admin/jobs/${d}/status`,c)).data.success?(i.success("Job status updated successfully!"),R(l),f(!1),L([]),fe()):i.error("Failed to update job status")}catch(c){i.error(((o=(n=c.response)==null?void 0:n.data)==null?void 0:o.message)||"Failed to update job status")}finally{$(!1)}}},xe=async a=>{var l,n,o,c,D;const t=a.target.files;if(!(t!=null&&t.length)||t.length<2){i.error("Please select at least 2 after images");return}if(t.length>4){i.error("Maximum 4 images allowed");return}U(!0);try{const m=new FormData;m.append("folder","after");for(let x=0;x<t.length;x++)m.append("images",t[x]);const N=await A.post("/admin/upload/images",m,{timeout:9e4});(l=N.data)!=null&&l.success&&((o=(n=N.data)==null?void 0:n.urls)!=null&&o.length)?(L(N.data.urls),i.success("Images uploaded")):i.error("Upload failed")}catch(m){i.error(((D=(c=m.response)==null?void 0:c.data)==null?void 0:D.message)||"Image upload failed")}finally{U(!1)}},ge=()=>{if(j.length<2){i.error("Please upload at least 2 after images");return}W("DELIVERED",j)},be=((F=s==null?void 0:s.customerId)==null?void 0:F.whatsappNumber)||((G=s==null?void 0:s.customerId)==null?void 0:G.phone)||"",h=Je(be),P=!!((q=r==null?void 0:r.shopWhatsappNumber)!=null&&q.trim()),je=(r==null?void 0:r.whatsappTemplates)||{},B=s?Be[s.status]:null,O=B&&je[B]||"",V=P&&h&&O,J=()=>{var x,ne;if(!V)return;const a=((x=s.customerId)==null?void 0:x.name)||"",t=((ne=s.carId)==null?void 0:ne.carNumber)||"",l=s.tokenNumber||"",n=s.beforeImages&&s.beforeImages.length?s.beforeImages[0]:"",o=s.afterImages&&s.afterImages.length?s.afterImages[0]:"",c=s.beforeImages&&s.beforeImages.length?s.beforeImages.join(`
`):"",D=s.afterImages&&s.afterImages.length?s.afterImages.join(`
`):"";let m=Fe(O,{name:a,vehicleNumber:t,token:l,beforeImagesLink:c,afterImagesLink:D});if(s.status==="DELIVERED"&&(n||o)){const k=[];n&&k.push(`Before photos: ${n}`),o&&k.push(`After photos: ${o}`),k.length&&(m=m.trimEnd()+`

`+k.join(`
`))}const N=`https://wa.me/${h}?text=${encodeURIComponent(m)}`;window.open(N,"_blank","noopener,noreferrer"),i.success("WhatsApp opened. Send the message to the customer.")},ve=()=>{var n;const a=(n=r==null?void 0:r.googleReviewLink)==null?void 0:n.trim();if(!a){i.error("Google Review link not set. Add it in WhatsApp Settings.");return}if(!h){i.error("Customer phone number is missing.");return}const t=`Thank you for choosing us ðŸ™
Please leave us a Google review: ${a}`,l=`https://wa.me/${h}?text=${encodeURIComponent(t)}`;window.open(l,"_blank","noopener,noreferrer"),i.success("WhatsApp opened. Send the review request to the customer.")};if(ue)return e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(we,{size:"section"})});if(!s)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{children:"Job not found"}),e.jsx(oe,{to:`${g}/jobs`,children:e.jsx(p,{children:"Back to Jobs"})})]});const v=(a=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[a])(s.status);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx(oe,{to:"/admin/jobs",className:"min-h-[44px] min-w-[44px] flex items-center justify-center",children:e.jsx(p,{variant:"ghost",size:"icon",children:e.jsx(ye,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-800",children:"Job Details"}),e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Token: ",s.tokenNumber]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(E,{children:[e.jsx(w,{children:e.jsx(y,{children:"Job Information"})}),e.jsxs(S,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Status"}),e.jsx(Ae,{className:Se("rounded-md",Ge[s.status]||""),children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Token Number"}),e.jsx("span",{className:"font-medium text-slate-800",children:s.tokenNumber})]}),s.assignedTo&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Assigned to"}),e.jsxs("span",{className:"font-medium text-slate-800",children:[s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Price"}),e.jsx("span",{className:"text-xl font-semibold text-primary",children:ce(Number(s.totalPrice),r==null?void 0:r.currency)})]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Estimated Delivery"}),e.jsx("span",{className:"font-medium",children:me(new Date(s.estimatedDelivery),"PPp")})]}),s.actualDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Actual Delivery"}),e.jsx("span",{className:"font-medium",children:me(new Date(s.actualDelivery),"PPp")})]})]})]}),e.jsxs(E,{children:[e.jsx(w,{children:e.jsx(y,{children:"Customer & Car"})}),e.jsxs(S,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(z=s.customerId)==null?void 0:z.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:(H=s.customerId)==null?void 0:H.phone})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(Y=s.carId)==null?void 0:Y.carNumber}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[(Q=s.carId)==null?void 0:Q.brand," ",(X=s.carId)==null?void 0:X.model," ",((Z=s.carId)==null?void 0:Z.color)&&`â€¢ ${s.carId.color}`]})]})]})]})]}),e.jsxs(E,{className:"md:col-span-2",children:[e.jsx(w,{children:e.jsx(y,{children:"Services"})}),e.jsx(S,{children:e.jsx("div",{className:"space-y-2",children:s.services&&s.services.map((a,t)=>{var l;return e.jsxs("div",{className:"flex items-center justify-between py-2 px-2 border-b border-border/60 last:border-0 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("span",{className:"text-slate-700",children:((l=a.serviceId)==null?void 0:l.name)||"Service"}),e.jsx("span",{className:"font-medium text-slate-800",children:ce(Number(a.price),r==null?void 0:r.currency)})]},t)})})})]}),(((ee=s.beforeImages)==null?void 0:ee.length)>0||((se=s.afterImages)==null?void 0:se.length)>0)&&e.jsxs(E,{className:"md:col-span-2",children:[e.jsxs(w,{children:[e.jsx(y,{children:"Job photos"}),e.jsx(ie,{children:"Before and after images of the car"})]}),e.jsxs(S,{className:"space-y-6",children:[((ae=s.beforeImages)==null?void 0:ae.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Before"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.beforeImages.map((a,t)=>e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:a,alt:`Before ${t+1}`,className:"h-32 w-auto object-cover"})},t))})]}),((te=s.afterImages)==null?void 0:te.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"After"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.afterImages.map((a,t)=>e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:a,alt:`After ${t+1}`,className:"h-32 w-auto object-cover"})},t))})]})]})]}),e.jsxs(E,{className:"md:col-span-2",children:[e.jsxs(w,{children:[e.jsx(y,{children:"Status & WhatsApp"}),e.jsx(ie,{children:"Update job status and send status messages to the customer via WhatsApp (click-to-chat)."})]}),e.jsxs(S,{className:"space-y-4",children:[s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(Te,{value:I,onValueChange:R,children:[e.jsx(Re,{className:"w-full sm:flex-1",children:e.jsx(Le,{})}),e.jsx(We,{children:qe.filter(a=>s.status==="RECEIVED"?a.value==="WORK_STARTED":s.status==="WORK_STARTED"?a.value==="COMPLETED":s.status==="COMPLETED"?a.value==="DELIVERED":!1).map(a=>e.jsx(Pe,{value:a.value,children:a.label},a.value))})]}),e.jsx(p,{onClick:()=>I==="DELIVERED"?f(!0):W(),disabled:b||I===s.status,className:"w-full sm:w-auto",children:b?"Updating...":"Update Status"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(p,{onClick:()=>v==="DELIVERED"?f(!0):W(v),disabled:b,className:"w-full sm:flex-1",children:[v==="WORK_STARTED"&&"â–¶ Mark Work Started",v==="COMPLETED"&&"âœ… Mark Completed",v==="DELIVERED"&&"ðŸš— Mark Delivered"]}),e.jsxs(p,{variant:"outline",onClick:J,disabled:!V,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:P?h?O?"Open WhatsApp with pre-filled message":"Template empty in WhatsApp Settings":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Send ",s.status.replace("_"," ")," WhatsApp"]})]})]}),s.status==="DELIVERED"&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(p,{variant:"outline",onClick:J,disabled:!V,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:P?h?"Open WhatsApp":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Send Delivered WhatsApp"]}),e.jsxs(p,{onClick:ve,disabled:!h||!((re=r==null?void 0:r.googleReviewLink)!=null&&re.trim()),className:"w-full sm:flex-1 bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200",title:(le=r==null?void 0:r.googleReviewLink)!=null&&le.trim()?"Open WhatsApp with review request":"Add Google Review link in WhatsApp Settings",children:[e.jsx(Ke,{className:"h-4 w-4 mr-2"}),"Ask for Google Review"]})]})]})]}),e.jsx(Oe,{open:he,onOpenChange:a=>{f(a),a||L([])},children:e.jsxs(Ve,{children:[e.jsxs(_e,{children:[e.jsx($e,{children:"Mark as Delivered"}),e.jsx(Me,{children:"Upload at least 2 after photos of the car. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(Ue,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:xe,disabled:M,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),M&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploadingâ€¦"}),j.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:j.map((a,t)=>e.jsx("img",{src:a,alt:`After ${t+1}`,className:"h-16 w-16 object-cover rounded border"},t))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(p,{variant:"outline",onClick:()=>f(!1),children:"Cancel"}),e.jsx(p,{onClick:ge,disabled:j.length<2||b,children:b?"Updating...":"Confirm Delivered"})]})]})})]})})]})]})}export{as as default};
