import{n as re,o as ie,r,a as I,u as c,j as e,V as ne,k as A,f as n,P as K,C as N,e as b,I as ce,l as oe}from"./index-o_2gjTLu.js";import{U as de,c as me,u as ue}from"./UploadOverlay-CNbmIMY9.js";import{u as xe}from"./usePortalPath-Bu-7VQPQ.js";import{B as he}from"./badge-DECccTTd.js";import{S as ge,a as pe,b as fe,c as je,d as ve}from"./select-Bb9Oo39L.js";import{D as Ne,a as be,b as ye,c as Ee,d as De,f as we}from"./dialog-7kLME1aO.js";import{f as Ce}from"./currencyUtils-CJd_f-r_.js";import{S as B}from"./search-CZ0m3mFL.js";import{C as Se}from"./clock-CtTEA6cd.js";import{a as q,C as Le}from"./chevron-right-Ds0J_p7o.js";import{f as G}from"./format-B3XKS-z2.js";const Ie={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},Ae=[{value:"ALL",label:"All Statuses"},{value:"RECEIVED",label:"Received"},{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}],P=10;function ze(){re();const y=xe(),{user:E}=ie(s=>s.auth),k=(E==null?void 0:E.role)==="EMPLOYEE",[f,H]=r.useState([]),[T,R]=r.useState(!0),[m,D]=r.useState("ALL"),[u,w]=r.useState(""),[O,C]=r.useState(""),[Y,Z]=r.useState("USD"),[o,x]=r.useState(1),[h,Q]=r.useState({total:0,totalPages:0}),[X,j]=r.useState(!1),[M,S]=r.useState(null),[g,v]=r.useState([]),[L,V]=r.useState(!1),[U,F]=r.useState(!1);r.useEffect(()=>{J()},[m,u,o]),r.useEffect(()=>{I.get("/admin/settings").then(s=>{var a,t;(a=s.data)!=null&&a.success&&((t=s.data.settings)!=null&&t.currency)&&Z(s.data.settings.currency)}).catch(()=>{})},[]);const J=async()=>{var s,a;R(!0);try{const t=new URLSearchParams;t.set("status",m),t.set("page",String(o)),t.set("limit",String(P)),u.trim()&&t.set("search",u.trim());const l=await I.get(`/admin/jobs?${t.toString()}`);l.data.success?(H(l.data.jobs||[]),l.data.pagination&&Q({total:l.data.pagination.total,totalPages:l.data.pagination.totalPages})):c.error("Failed to load jobs")}catch(t){c.error(((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to load jobs")}finally{R(!1)}},_=s=>{s==null||s.preventDefault(),w(O),x(1)},z=s=>{s<1||s>h.totalPages||x(s)},$=async(s,a,t=null)=>{var l,d;try{const i={status:a};t!=null&&t.length&&(i.afterImages=t),(await I.patch(`/admin/jobs/${s}/status`,i)).data.success?(c.success("Job status updated successfully!"),J()):c.error("Failed to update job status")}catch(i){c.error(((d=(l=i.response)==null?void 0:l.data)==null?void 0:d.message)||"Failed to update job status")}},ee=s=>{S(s),v([]),j(!0)},se=async s=>{var t;const a=s.target.files;if(!(a!=null&&a.length)||a.length<2){c.error("Please select at least 2 after images");return}if(a.length>4){c.error("Maximum 4 images allowed");return}V(!0);try{const l=await me(a),d=new FormData;d.append("folder","after"),l.forEach(p=>d.append("images",p));const i=await ue(d);(t=i==null?void 0:i.urls)!=null&&t.length?(v(i.urls),c.success("Images uploaded")):c.error("Upload failed")}catch(l){c.error((l==null?void 0:l.message)||"Image upload failed")}finally{V(!1)}},ae=async()=>{if(!M||g.length<2){c.error("Please upload at least 2 after images");return}F(!0);try{await $(M,"DELIVERED",g),j(!1),S(null),v([])}finally{F(!1)}},te=s=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[s];return T?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(ne,{size:"section"})}):e.jsxs(e.Fragment,{children:[e.jsx(de,{show:L,message:"Uploading images…"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-foreground",children:k?"My Jobs":"Jobs"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:k?"Jobs assigned to you. Create new jobs or manage status and delivery.":"Manage all car wash jobs. Open a job to update status and send WhatsApp messages to the customer."})]}),e.jsx(A,{to:`${y}/jobs/new`,className:"min-h-[44px] flex items-center",children:e.jsxs(n,{className:"w-full sm:w-auto gap-2",children:[e.jsx(K,{className:"h-4 w-4"}),"New Job"]})})]}),e.jsx(N,{children:e.jsx(b,{className:"p-6",children:e.jsxs("form",{onSubmit:_,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-2 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(B,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ce,{placeholder:"Search by token, customer name, phone, or car number...",value:O,onChange:s=>C(s.target.value),onKeyDown:s=>s.key==="Enter"&&_(s),className:"pl-9"})]}),e.jsx(n,{type:"submit",variant:"secondary",size:"icon",className:"shrink-0 h-10 w-10",title:"Search",children:e.jsx(B,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs(ge,{value:m,onValueChange:s=>{D(s),x(1)},children:[e.jsx(pe,{className:"w-[180px]",children:e.jsx(fe,{placeholder:"Status"})}),e.jsx(je,{children:Ae.map(s=>e.jsx(ve,{value:s.value,children:s.label},s.value))})]}),(u||m!=="ALL")&&e.jsx(n,{type:"button",variant:"ghost",size:"sm",onClick:()=>{w(""),C(""),D("ALL"),x(1)},children:"Clear"})]})]})})}),e.jsxs("div",{className:"grid gap-4",children:[f.map(s=>{var t,l,d,i,p;const a=te(s.status);return e.jsx(N,{className:"transition-shadow duration-150",children:e.jsx(b,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Token: ",s.tokenNumber]}),e.jsx(he,{className:Ie[s.status]||"",children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{children:(t=s.carId)==null?void 0:t.carNumber}),((l=s.carId)==null?void 0:l.brand)&&((d=s.carId)==null?void 0:d.model)&&e.jsxs("span",{children:["• ",s.carId.brand," ",s.carId.model]})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Customer:"})," ",(i=s.customerId)==null?void 0:i.name," • ",(p=s.customerId)==null?void 0:p.phone]}),s.assignedTo&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Assigned to: ",s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsxs("span",{children:["ETA: ",G(new Date(s.estimatedDelivery),"PPp")]})]}),s.services&&s.services.length>0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Services: ",s.services.map(le=>{var W;return((W=le.serviceId)==null?void 0:W.name)||"N/A"}).join(", ")]})]}),e.jsxs("div",{className:"sm:text-right space-y-2 flex-shrink-0",children:[e.jsx("div",{className:"text-xl sm:text-2xl font-semibold text-slate-800",children:Ce(Number(s.totalPrice),Y)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:G(new Date(s.createdAt),"MMM d, yyyy")}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[a&&s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&(a==="DELIVERED"?e.jsx(n,{size:"sm",onClick:()=>ee(s._id),children:"Mark as Delivered"}):e.jsxs(n,{size:"sm",onClick:()=>$(s._id,a),children:["Mark as ",a.replace("_"," ")]})),e.jsx(A,{to:`${y}/jobs/${s._id}`,className:"min-h-[40px] flex items-center",children:e.jsxs(n,{size:"sm",variant:"outline",className:"w-full sm:w-auto gap-1",children:[e.jsx(q,{className:"h-4 w-4"}),"View details"]})})]})]})]})})},s._id)}),f.length===0&&!T&&e.jsx(N,{children:e.jsxs(b,{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:u||m!=="ALL"?"No jobs match your search or filter.":"No jobs found"}),u||m!=="ALL"?e.jsx(n,{className:"mt-4",variant:"outline",onClick:()=>{w(""),C(""),D("ALL"),x(1)},children:"Clear filters"}):e.jsx(A,{to:`${y}/jobs/new`,children:e.jsxs(n,{className:"mt-4",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Create First Job"]})})]})})]}),e.jsx(Ne,{open:X,onOpenChange:s=>{j(s),s||S(null),v([])},children:e.jsxs(be,{children:[e.jsxs(ye,{children:[e.jsx(Ee,{children:"Mark as Delivered"}),e.jsx(De,{children:"Upload at least 2 after photos of the car. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(we,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:se,disabled:L,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),L&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),g.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((s,a)=>e.jsx("img",{src:s,alt:`After ${a+1}`,className:"h-16 w-16 object-cover rounded border"},a))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(n,{variant:"outline",onClick:()=>j(!1),children:"Cancel"}),e.jsx(n,{onClick:ae,disabled:g.length<2||U,children:U?"Updating...":"Confirm Delivered"})]})]})})]})}),h.totalPages>1&&e.jsx(N,{children:e.jsx(b,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",f.length===0?0:(o-1)*P+1,"–",(o-1)*P+f.length," of ",h.total," jobs"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>z(o-1),disabled:o<=1,children:[e.jsx(Le,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs("span",{className:"text-sm px-2",children:["Page ",o," of ",h.totalPages]}),e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>z(o+1),disabled:o>=h.totalPages,children:["Next",e.jsx(q,{className:"h-4 w-4 ml-1"})]})]})]})})})]})]})}export{ze as default};
