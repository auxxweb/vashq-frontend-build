import{i as De,q as Ee,n as Ne,r as m,a as W,u as i,j as e,V as we,k as ne,f as u,A as ye,C as j,b as v,c as D,e as E,h as Se,s as Ie,l as Ce,d as oe,M as ie}from"./index-BW20lZeO.js";import{M as Ae,u as ke}from"./uploadImages-BbuQiL50.js";import{u as Te}from"./usePortalPath-fDGWwlGx.js";import{B as Re}from"./badge-Cyx4j5sX.js";import{S as Le,a as We,b as Pe,c as Oe,d as Ve}from"./select-rIuRCf4V.js";import{D as Me,a as _e,b as $e,c as Ue,d as Be,f as Ke}from"./dialog-DFhCNs-i.js";import{f as de}from"./currencyUtils-CJd_f-r_.js";import{f as ce}from"./format-B3XKS-z2.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=De("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]),Fe={RECEIVED:"received",WORK_STARTED:"workStarted",COMPLETED:"completed",DELIVERED:"delivered"};function Ge(d){return!d||typeof d!="string"?"":d.replace(/\D/g,"").trim()}function qe(d,{name:N="",vehicleNumber:f="",token:s="",beforeImagesLink:S="",afterImagesLink:l=""}){return d?d.replace(/\{\{name\}\}/g,String(N)).replace(/\{\{vehicleNumber\}\}/g,String(f)).replace(/\{\{token\}\}/g,String(s)).replace(/\{\{beforeImagesLink\}\}/g,String(S)).replace(/\{\{afterImagesLink\}\}/g,String(l)):""}const ze={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},He=[{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}];function ls(){var B,K,J,F,G,q,z,H,X,Y,Z,Q,ee,se,ae;const{id:d}=Ee(),N=Ne(),f=Te(),[s,S]=m.useState(null),[l,P]=m.useState(null),[me,ue]=m.useState(!0),[x,O]=m.useState(!1),[w,I]=m.useState(""),[pe,h]=m.useState(!1),[g,C]=m.useState([]),[V,M]=m.useState(!1);m.useEffect(()=>{d&&_()},[d]);const _=async()=>{var a,t,n;try{const[r,o]=await Promise.all([W.get(`/admin/jobs/${d}`),W.get("/admin/settings").catch(()=>({data:{}}))]);r.data.success?(S(r.data.job),I(r.data.job.status)):(i.error("Failed to load job"),N(`${f}/jobs`)),(a=o==null?void 0:o.data)!=null&&a.success&&o.data.settings?P(o.data.settings):P({})}catch(r){i.error(((n=(t=r.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to load job"),N(`${f}/jobs`)}finally{ue(!1)}},he=()=>_(),A=async(a,t=null)=>{var r,o;const n=a??w;if(!(!n||n===s.status)){if(n==="DELIVERED"&&(!t||t.length<2)){h(!0);return}O(!0);try{const c={status:n};t!=null&&t.length&&(c.afterImages=t),(await W.patch(`/admin/jobs/${d}/status`,c)).data.success?(i.success("Job status updated successfully!"),I(n),h(!1),C([]),he()):i.error("Failed to update job status")}catch(c){i.error(((o=(r=c.response)==null?void 0:r.data)==null?void 0:o.message)||"Failed to update job status")}finally{O(!1)}}},fe=async a=>{var n;const t=a.target.files;if(!(t!=null&&t.length)||t.length<2){i.error("Please select at least 2 after images");return}if(t.length>4){i.error("Maximum 4 images allowed");return}for(let r=0;r<t.length;r++)if(t[r].size>Ae){i.error("One or more images are too large. Use images under 12MB each.");return}M(!0);try{const r=new FormData;r.append("folder","after");for(let c=0;c<t.length;c++)r.append("images",t[c]);const o=await ke(r);(n=o==null?void 0:o.urls)!=null&&n.length?(C(o.urls),i.success("Images uploaded")):i.error("Upload failed")}catch(r){i.error((r==null?void 0:r.message)||"Image upload failed")}finally{M(!1)}},xe=()=>{if(g.length<2){i.error("Please upload at least 2 after images");return}A("DELIVERED",g)},ge=((B=s==null?void 0:s.customerId)==null?void 0:B.whatsappNumber)||((K=s==null?void 0:s.customerId)==null?void 0:K.phone)||"",p=Ge(ge),k=!!((J=l==null?void 0:l.shopWhatsappNumber)!=null&&J.trim()),be=(l==null?void 0:l.whatsappTemplates)||{},$=s?Fe[s.status]:null,T=$&&be[$]||"",R=k&&p&&T,U=()=>{var re,le;if(!R)return;const a=((re=s.customerId)==null?void 0:re.name)||"",t=((le=s.carId)==null?void 0:le.carNumber)||"",n=s.tokenNumber||"",r=s.beforeImages&&s.beforeImages.length?s.beforeImages[0]:"",o=s.afterImages&&s.afterImages.length?s.afterImages[0]:"",c=s.beforeImages&&s.beforeImages.length?s.beforeImages.join(`
`):"",te=s.afterImages&&s.afterImages.length?s.afterImages.join(`
`):"";let L=qe(T,{name:a,vehicleNumber:t,token:n,beforeImagesLink:c,afterImagesLink:te});if(s.status==="DELIVERED"&&(r||o)){const y=[];r&&y.push(`Before photos: ${r}`),o&&y.push(`After photos: ${o}`),y.length&&(L=L.trimEnd()+`

`+y.join(`
`))}const ve=`https://wa.me/${p}?text=${encodeURIComponent(L)}`;window.open(ve,"_blank","noopener,noreferrer"),i.success("WhatsApp opened. Send the message to the customer.")},je=()=>{var r;const a=(r=l==null?void 0:l.googleReviewLink)==null?void 0:r.trim();if(!a){i.error("Google Review link not set. Add it in WhatsApp Settings.");return}if(!p){i.error("Customer phone number is missing.");return}const t=`Thank you for choosing us ðŸ™
Please leave us a Google review: ${a}`,n=`https://wa.me/${p}?text=${encodeURIComponent(t)}`;window.open(n,"_blank","noopener,noreferrer"),i.success("WhatsApp opened. Send the review request to the customer.")};if(me)return e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(we,{size:"section"})});if(!s)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{children:"Job not found"}),e.jsx(ne,{to:`${f}/jobs`,children:e.jsx(u,{children:"Back to Jobs"})})]});const b=(a=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[a])(s.status);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx(ne,{to:"/admin/jobs",className:"min-h-[44px] min-w-[44px] flex items-center justify-center",children:e.jsx(u,{variant:"ghost",size:"icon",children:e.jsx(ye,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-800",children:"Job Details"}),e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Token: ",s.tokenNumber]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(j,{children:[e.jsx(v,{children:e.jsx(D,{children:"Job Information"})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Status"}),e.jsx(Re,{className:Se("rounded-md",ze[s.status]||""),children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Token Number"}),e.jsx("span",{className:"font-medium text-slate-800",children:s.tokenNumber})]}),s.assignedTo&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Assigned to"}),e.jsxs("span",{className:"font-medium text-slate-800",children:[s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Price"}),e.jsx("span",{className:"text-xl font-semibold text-primary",children:de(Number(s.totalPrice),l==null?void 0:l.currency)})]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Estimated Delivery"}),e.jsx("span",{className:"font-medium",children:ce(new Date(s.estimatedDelivery),"PPp")})]}),s.actualDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Actual Delivery"}),e.jsx("span",{className:"font-medium",children:ce(new Date(s.actualDelivery),"PPp")})]})]})]}),e.jsxs(j,{children:[e.jsx(v,{children:e.jsx(D,{children:"Customer & Car"})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(F=s.customerId)==null?void 0:F.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:(G=s.customerId)==null?void 0:G.phone})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(q=s.carId)==null?void 0:q.carNumber}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[(z=s.carId)==null?void 0:z.brand," ",(H=s.carId)==null?void 0:H.model," ",((X=s.carId)==null?void 0:X.color)&&`â€¢ ${s.carId.color}`]})]})]})]})]}),e.jsxs(j,{className:"md:col-span-2",children:[e.jsx(v,{children:e.jsx(D,{children:"Services"})}),e.jsx(E,{children:e.jsx("div",{className:"space-y-2",children:s.services&&s.services.map((a,t)=>{var n;return e.jsxs("div",{className:"flex items-center justify-between py-2 px-2 border-b border-border/60 last:border-0 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("span",{className:"text-slate-700",children:((n=a.serviceId)==null?void 0:n.name)||"Service"}),e.jsx("span",{className:"font-medium text-slate-800",children:de(Number(a.price),l==null?void 0:l.currency)})]},t)})})})]}),(((Y=s.beforeImages)==null?void 0:Y.length)>0||((Z=s.afterImages)==null?void 0:Z.length)>0)&&e.jsxs(j,{className:"md:col-span-2",children:[e.jsxs(v,{children:[e.jsx(D,{children:"Job photos"}),e.jsx(oe,{children:"Before and after images of the car"})]}),e.jsxs(E,{className:"space-y-6",children:[((Q=s.beforeImages)==null?void 0:Q.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Before"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.beforeImages.map((a,t)=>e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:a,alt:`Before ${t+1}`,className:"h-32 w-auto object-cover"})},t))})]}),((ee=s.afterImages)==null?void 0:ee.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"After"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.afterImages.map((a,t)=>e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:a,alt:`After ${t+1}`,className:"h-32 w-auto object-cover"})},t))})]})]})]}),e.jsxs(j,{className:"md:col-span-2",children:[e.jsxs(v,{children:[e.jsx(D,{children:"Status & WhatsApp"}),e.jsx(oe,{children:"Update job status and send status messages to the customer via WhatsApp (click-to-chat)."})]}),e.jsxs(E,{className:"space-y-4",children:[s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(Le,{value:w,onValueChange:I,children:[e.jsx(We,{className:"w-full sm:flex-1",children:e.jsx(Pe,{})}),e.jsx(Oe,{children:He.filter(a=>s.status==="RECEIVED"?a.value==="WORK_STARTED":s.status==="WORK_STARTED"?a.value==="COMPLETED":s.status==="COMPLETED"?a.value==="DELIVERED":!1).map(a=>e.jsx(Ve,{value:a.value,children:a.label},a.value))})]}),e.jsx(u,{onClick:()=>w==="DELIVERED"?h(!0):A(),disabled:x||w===s.status,className:"w-full sm:w-auto",children:x?"Updating...":"Update Status"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(u,{onClick:()=>b==="DELIVERED"?h(!0):A(b),disabled:x,className:"w-full sm:flex-1",children:[b==="WORK_STARTED"&&"â–¶ Mark Work Started",b==="COMPLETED"&&"âœ… Mark Completed",b==="DELIVERED"&&"ðŸš— Mark Delivered"]}),e.jsxs(u,{variant:"outline",onClick:U,disabled:!R,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:k?p?T?"Open WhatsApp with pre-filled message":"Template empty in WhatsApp Settings":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Send ",s.status.replace("_"," ")," WhatsApp"]})]})]}),s.status==="DELIVERED"&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(u,{variant:"outline",onClick:U,disabled:!R,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:k?p?"Open WhatsApp":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Send Delivered WhatsApp"]}),e.jsxs(u,{onClick:je,disabled:!p||!((se=l==null?void 0:l.googleReviewLink)!=null&&se.trim()),className:"w-full sm:flex-1 bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200",title:(ae=l==null?void 0:l.googleReviewLink)!=null&&ae.trim()?"Open WhatsApp with review request":"Add Google Review link in WhatsApp Settings",children:[e.jsx(Je,{className:"h-4 w-4 mr-2"}),"Ask for Google Review"]})]})]})]}),e.jsx(Me,{open:pe,onOpenChange:a=>{h(a),a||C([])},children:e.jsxs(_e,{children:[e.jsxs($e,{children:[e.jsx(Ue,{children:"Mark as Delivered"}),e.jsx(Be,{children:"Upload at least 2 after photos of the car. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(Ke,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:fe,disabled:V,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),V&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploadingâ€¦"}),g.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((a,t)=>e.jsx("img",{src:a,alt:`After ${t+1}`,className:"h-16 w-16 object-cover rounded border"},t))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>h(!1),children:"Cancel"}),e.jsx(u,{onClick:xe,disabled:g.length<2||x,children:x?"Updating...":"Confirm Delivered"})]})]})})]})})]})]})}export{ls as default};
