import{i as je,q as ve,n as Ee,r as m,a as O,u as d,j as e,V as De,k as ne,f as c,A as Ne,C as g,b as j,c as v,e as E,h as we,s as ye,l as Se,d as le,M as oe}from"./index-D5eo3nMI.js";import{M as Ie,a as Ce,b as D}from"./MultiImageUpload-Wwfmm4Gr.js";import{u as Ae}from"./usePortalPath-kWBXknMv.js";import{B as ke}from"./badge-ajqDAm-k.js";import{S as Te,a as Re,b as Le,c as We,d as Oe}from"./select-CN9qpzQy.js";import{D as Pe,a as Me,b as Ve,c as _e,d as $e,f as Ue}from"./dialog-B4ZJCXOO.js";import{f as ie}from"./currencyUtils-CJd_f-r_.js";import{f as de}from"./format-B3XKS-z2.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=je("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]),Je={RECEIVED:"received",WORK_STARTED:"workStarted",COMPLETED:"completed",DELIVERED:"delivered"};function Ke(i){return!i||typeof i!="string"?"":i.replace(/\D/g,"").trim()}function Fe(i,{name:N="",vehicleNumber:x="",token:s="",beforeImagesLink:I="",afterImagesLink:a=""}){return i?i.replace(/\{\{name\}\}/g,String(N)).replace(/\{\{vehicleNumber\}\}/g,String(x)).replace(/\{\{token\}\}/g,String(s)).replace(/\{\{beforeImagesLink\}\}/g,String(I)).replace(/\{\{afterImagesLink\}\}/g,String(a)):""}const Ge={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},qe=[{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}];function as(){var U,B,J,K,F,G,q,z,H,X,Y,Q,Z,ee,se;const{id:i}=ve(),N=Ee(),x=Ae(),[s,I]=m.useState(null),[a,P]=m.useState(null),[ce,me]=m.useState(!0),[f,M]=m.useState(!1),[w,C]=m.useState(""),[ue,h]=m.useState(!1),[y,A]=m.useState([]);m.useEffect(()=>{i&&V()},[i]);const V=async()=>{var t,r,n;try{const[l,o]=await Promise.all([O.get(`/admin/jobs/${i}`),O.get("/admin/settings").catch(()=>({data:{}}))]);l.data.success?(I(l.data.job),C(l.data.job.status)):(d.error("Failed to load job"),N(`${x}/jobs`)),(t=o==null?void 0:o.data)!=null&&t.success&&o.data.settings?P(o.data.settings):P({})}catch(l){d.error(((n=(r=l.response)==null?void 0:r.data)==null?void 0:n.message)||"Failed to load job"),N(`${x}/jobs`)}finally{me(!1)}},he=()=>V(),k=async(t,r=null)=>{var l,o;const n=t??w;if(!(!n||n===s.status)){if(n==="DELIVERED"&&(!r||r.length<D)){h(!0);return}M(!0);try{const p={status:n};r!=null&&r.length&&(p.afterImages=r),(await O.patch(`/admin/jobs/${i}/status`,p)).data.success?(d.success("Job status updated successfully!"),C(n),h(!1),A([]),he()):d.error("Failed to update job status")}catch(p){d.error(((o=(l=p.response)==null?void 0:l.data)==null?void 0:o.message)||"Failed to update job status")}finally{M(!1)}}},pe=()=>{if(y.length<D){d.error(`Please upload at least ${D} after images`);return}k("DELIVERED",y)},xe=((U=s==null?void 0:s.customerId)==null?void 0:U.whatsappNumber)||((B=s==null?void 0:s.customerId)==null?void 0:B.phone)||"",u=Ke(xe),T=!!((J=a==null?void 0:a.shopWhatsappNumber)!=null&&J.trim()),fe=(a==null?void 0:a.whatsappTemplates)||{},_=s?Je[s.status]:null,R=_&&fe[_]||"",L=T&&u&&R,$=()=>{var ae,re;if(!L)return;const t=((ae=s.customerId)==null?void 0:ae.name)||"",r=((re=s.carId)==null?void 0:re.carNumber)||"",n=s.tokenNumber||"",l=s.beforeImages&&s.beforeImages.length?s.beforeImages[0]:"",o=s.afterImages&&s.afterImages.length?s.afterImages[0]:"",p=s.beforeImages&&s.beforeImages.length?s.beforeImages.join(`
`):"",te=s.afterImages&&s.afterImages.length?s.afterImages.join(`
`):"";let W=Fe(R,{name:t,vehicleNumber:r,token:n,beforeImagesLink:p,afterImagesLink:te});if(s.status==="DELIVERED"&&(l||o)){const S=[];l&&S.push(`Before photos: ${l}`),o&&S.push(`After photos: ${o}`),S.length&&(W=W.trimEnd()+`

`+S.join(`
`))}const ge=`https://wa.me/${u}?text=${encodeURIComponent(W)}`;window.open(ge,"_blank","noopener,noreferrer"),d.success("WhatsApp opened. Send the message to the customer.")},be=()=>{var l;const t=(l=a==null?void 0:a.googleReviewLink)==null?void 0:l.trim();if(!t){d.error("Google Review link not set. Add it in WhatsApp Settings.");return}if(!u){d.error("Customer phone number is missing.");return}const r=`Thank you for choosing us ðŸ™
Please leave us a Google review: ${t}`,n=`https://wa.me/${u}?text=${encodeURIComponent(r)}`;window.open(n,"_blank","noopener,noreferrer"),d.success("WhatsApp opened. Send the review request to the customer.")};if(ce)return e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(De,{size:"section"})});if(!s)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{children:"Job not found"}),e.jsx(ne,{to:`${x}/jobs`,children:e.jsx(c,{children:"Back to Jobs"})})]});const b=(t=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[t])(s.status);return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx(ne,{to:"/admin/jobs",className:"min-h-[44px] min-w-[44px] flex items-center justify-center",children:e.jsx(c,{variant:"ghost",size:"icon",children:e.jsx(Ne,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-800",children:"Job Details"}),e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Token: ",s.tokenNumber]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(g,{children:[e.jsx(j,{children:e.jsx(v,{children:"Job Information"})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Status"}),e.jsx(ke,{className:we("rounded-md",Ge[s.status]||""),children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Token Number"}),e.jsx("span",{className:"font-medium text-slate-800",children:s.tokenNumber})]}),s.assignedTo&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Assigned to"}),e.jsxs("span",{className:"font-medium text-slate-800",children:[s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Price"}),e.jsx("span",{className:"text-xl font-semibold text-primary",children:ie(Number(s.totalPrice),a==null?void 0:a.currency)})]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Estimated Delivery"}),e.jsx("span",{className:"font-medium",children:de(new Date(s.estimatedDelivery),"PPp")})]}),s.actualDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Actual Delivery"}),e.jsx("span",{className:"font-medium",children:de(new Date(s.actualDelivery),"PPp")})]})]})]}),e.jsxs(g,{children:[e.jsx(j,{children:e.jsx(v,{children:"Customer & Car"})}),e.jsxs(E,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(K=s.customerId)==null?void 0:K.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:(F=s.customerId)==null?void 0:F.phone})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(G=s.carId)==null?void 0:G.carNumber}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[(q=s.carId)==null?void 0:q.brand," ",(z=s.carId)==null?void 0:z.model," ",((H=s.carId)==null?void 0:H.color)&&`â€¢ ${s.carId.color}`]})]})]})]})]}),e.jsxs(g,{className:"md:col-span-2",children:[e.jsx(j,{children:e.jsx(v,{children:"Services"})}),e.jsx(E,{children:e.jsx("div",{className:"space-y-2",children:s.services&&s.services.map((t,r)=>{var n;return e.jsxs("div",{className:"flex items-center justify-between py-2 px-2 border-b border-border/60 last:border-0 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("span",{className:"text-slate-700",children:((n=t.serviceId)==null?void 0:n.name)||"Service"}),e.jsx("span",{className:"font-medium text-slate-800",children:ie(Number(t.price),a==null?void 0:a.currency)})]},r)})})})]}),(((X=s.beforeImages)==null?void 0:X.length)>0||((Y=s.afterImages)==null?void 0:Y.length)>0)&&e.jsxs(g,{className:"md:col-span-2",children:[e.jsxs(j,{children:[e.jsx(v,{children:"Job photos"}),e.jsx(le,{children:"Before and after images of the car"})]}),e.jsxs(E,{className:"space-y-6",children:[((Q=s.beforeImages)==null?void 0:Q.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Before"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.beforeImages.map((t,r)=>e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:t,alt:`Before ${r+1}`,className:"h-32 w-auto object-cover"})},r))})]}),((Z=s.afterImages)==null?void 0:Z.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"After"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.afterImages.map((t,r)=>e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:t,alt:`After ${r+1}`,className:"h-32 w-auto object-cover"})},r))})]})]})]}),e.jsxs(g,{className:"md:col-span-2",children:[e.jsxs(j,{children:[e.jsx(v,{children:"Status & WhatsApp"}),e.jsx(le,{children:"Update job status and send status messages to the customer via WhatsApp (click-to-chat)."})]}),e.jsxs(E,{className:"space-y-4",children:[s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(Te,{value:w,onValueChange:C,children:[e.jsx(Re,{className:"w-full sm:flex-1",children:e.jsx(Le,{})}),e.jsx(We,{children:qe.filter(t=>s.status==="RECEIVED"?t.value==="WORK_STARTED":s.status==="WORK_STARTED"?t.value==="COMPLETED":s.status==="COMPLETED"?t.value==="DELIVERED":!1).map(t=>e.jsx(Oe,{value:t.value,children:t.label},t.value))})]}),e.jsx(c,{onClick:()=>w==="DELIVERED"?h(!0):k(),disabled:f||w===s.status,className:"w-full sm:w-auto",children:f?"Updating...":"Update Status"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(c,{onClick:()=>b==="DELIVERED"?h(!0):k(b),disabled:f,className:"w-full sm:flex-1",children:[b==="WORK_STARTED"&&"â–¶ Mark Work Started",b==="COMPLETED"&&"âœ… Mark Completed",b==="DELIVERED"&&"ðŸš— Mark Delivered"]}),e.jsxs(c,{variant:"outline",onClick:$,disabled:!L,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:T?u?R?"Open WhatsApp with pre-filled message":"Template empty in WhatsApp Settings":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Send ",s.status.replace("_"," ")," WhatsApp"]})]})]}),s.status==="DELIVERED"&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(c,{variant:"outline",onClick:$,disabled:!L,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:T?u?"Open WhatsApp":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),"Send Delivered WhatsApp"]}),e.jsxs(c,{onClick:be,disabled:!u||!((ee=a==null?void 0:a.googleReviewLink)!=null&&ee.trim()),className:"w-full sm:flex-1 bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200",title:(se=a==null?void 0:a.googleReviewLink)!=null&&se.trim()?"Open WhatsApp with review request":"Add Google Review link in WhatsApp Settings",children:[e.jsx(Be,{className:"h-4 w-4 mr-2"}),"Ask for Google Review"]})]})]})]}),e.jsx(Pe,{open:ue,onOpenChange:t=>{h(t),t||A([])},children:e.jsxs(Me,{children:[e.jsxs(Ve,{children:[e.jsx(_e,{children:"Mark as Delivered"}),e.jsx($e,{children:"Upload at least 2 after photos of the car. Add one by one from camera or gallery. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(Ue,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx(Ie,{value:y,onChange:A,folder:"after",minImages:D,maxImages:Ce,label:"",description:"Add after photos one by one. Minimum 2, maximum 4.",thumbnailClassName:"h-16 w-16 object-cover rounded border"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(c,{variant:"outline",onClick:()=>h(!1),children:"Cancel"}),e.jsx(c,{onClick:pe,disabled:y.length<D||f,children:f?"Updating...":"Confirm Delivered"})]})]})})]})})]})]})})}export{as as default};
