import{n as re,o as ie,r,a as L,u as c,j as e,V as ne,k as A,f as i,P as K,C as v,e as N,I as ce,l as oe}from"./index-3RdFwQhj.js";import{u as de}from"./uploadImages-gmnmf3Ru.js";import{u as me}from"./usePortalPath-CKaWAX-Z.js";import{B as ue}from"./badge-AYM_8aO2.js";import{S as xe,a as he,b as ge,c as fe,d as pe}from"./select-CUIkZR0j.js";import{D as je,a as ve,b as Ne,c as be,d as ye,f as De}from"./dialog-APH2rfZm.js";import{f as Ee}from"./currencyUtils-CJd_f-r_.js";import{S as B}from"./search-W-BlN4Ve.js";import{C as Ce}from"./clock-DbGwbc-N.js";import{a as q,C as we}from"./chevron-right-D2_Ahiaf.js";import{f as G}from"./format-B3XKS-z2.js";const Se={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},Le=[{value:"ALL",label:"All Statuses"},{value:"RECEIVED",label:"Received"},{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}],I=10;function Fe(){re();const b=me(),{user:y}=ie(s=>s.auth),P=(y==null?void 0:y.role)==="EMPLOYEE",[f,H]=r.useState([]),[k,T]=r.useState(!0),[m,D]=r.useState("ALL"),[u,E]=r.useState(""),[R,C]=r.useState(""),[Y,Z]=r.useState("USD"),[d,x]=r.useState(1),[h,Q]=r.useState({total:0,totalPages:0}),[X,p]=r.useState(!1),[M,w]=r.useState(null),[g,j]=r.useState([]),[O,V]=r.useState(!1),[J,_]=r.useState(!1);r.useEffect(()=>{F()},[m,u,d]),r.useEffect(()=>{L.get("/admin/settings").then(s=>{var a,t;(a=s.data)!=null&&a.success&&((t=s.data.settings)!=null&&t.currency)&&Z(s.data.settings.currency)}).catch(()=>{})},[]);const F=async()=>{var s,a;T(!0);try{const t=new URLSearchParams;t.set("status",m),t.set("page",String(d)),t.set("limit",String(I)),u.trim()&&t.set("search",u.trim());const l=await L.get(`/admin/jobs?${t.toString()}`);l.data.success?(H(l.data.jobs||[]),l.data.pagination&&Q({total:l.data.pagination.total,totalPages:l.data.pagination.totalPages})):c.error("Failed to load jobs")}catch(t){c.error(((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to load jobs")}finally{T(!1)}},U=s=>{s==null||s.preventDefault(),E(R),x(1)},z=s=>{s<1||s>h.totalPages||x(s)},$=async(s,a,t=null)=>{var l,o;try{const n={status:a};t!=null&&t.length&&(n.afterImages=t),(await L.patch(`/admin/jobs/${s}/status`,n)).data.success?(c.success("Job status updated successfully!"),F()):c.error("Failed to update job status")}catch(n){c.error(((o=(l=n.response)==null?void 0:l.data)==null?void 0:o.message)||"Failed to update job status")}},ee=s=>{w(s),j([]),p(!0)},se=async s=>{var t;const a=s.target.files;if(!(a!=null&&a.length)||a.length<2){c.error("Please select at least 2 after images");return}if(a.length>4){c.error("Maximum 4 images allowed");return}V(!0);try{const l=new FormData;l.append("folder","after");for(let n=0;n<a.length;n++)l.append("images",a[n]);const o=await de(l);(t=o==null?void 0:o.urls)!=null&&t.length?(j(o.urls),c.success("Images uploaded")):c.error("Upload failed")}catch(l){c.error((l==null?void 0:l.message)||"Image upload failed")}finally{V(!1)}},ae=async()=>{if(!M||g.length<2){c.error("Please upload at least 2 after images");return}_(!0);try{await $(M,"DELIVERED",g),p(!1),w(null),j([])}finally{_(!1)}},te=s=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[s];return k?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(ne,{size:"section"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-foreground",children:P?"My Jobs":"Jobs"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:P?"Jobs assigned to you. Create new jobs or manage status and delivery.":"Manage all car wash jobs. Open a job to update status and send WhatsApp messages to the customer."})]}),e.jsx(A,{to:`${b}/jobs/new`,className:"min-h-[44px] flex items-center",children:e.jsxs(i,{className:"w-full sm:w-auto gap-2",children:[e.jsx(K,{className:"h-4 w-4"}),"New Job"]})})]}),e.jsx(v,{children:e.jsx(N,{className:"p-6",children:e.jsxs("form",{onSubmit:U,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-2 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(B,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ce,{placeholder:"Search by token, customer name, phone, or car number...",value:R,onChange:s=>C(s.target.value),onKeyDown:s=>s.key==="Enter"&&U(s),className:"pl-9"})]}),e.jsx(i,{type:"submit",variant:"secondary",size:"icon",className:"shrink-0 h-10 w-10",title:"Search",children:e.jsx(B,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs(xe,{value:m,onValueChange:s=>{D(s),x(1)},children:[e.jsx(he,{className:"w-[180px]",children:e.jsx(ge,{placeholder:"Status"})}),e.jsx(fe,{children:Le.map(s=>e.jsx(pe,{value:s.value,children:s.label},s.value))})]}),(u||m!=="ALL")&&e.jsx(i,{type:"button",variant:"ghost",size:"sm",onClick:()=>{E(""),C(""),D("ALL"),x(1)},children:"Clear"})]})]})})}),e.jsxs("div",{className:"grid gap-4",children:[f.map(s=>{var t,l,o,n,S;const a=te(s.status);return e.jsx(v,{className:"transition-shadow duration-150",children:e.jsx(N,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Token: ",s.tokenNumber]}),e.jsx(ue,{className:Se[s.status]||"",children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{children:(t=s.carId)==null?void 0:t.carNumber}),((l=s.carId)==null?void 0:l.brand)&&((o=s.carId)==null?void 0:o.model)&&e.jsxs("span",{children:["• ",s.carId.brand," ",s.carId.model]})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Customer:"})," ",(n=s.customerId)==null?void 0:n.name," • ",(S=s.customerId)==null?void 0:S.phone]}),s.assignedTo&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Assigned to: ",s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ce,{className:"h-4 w-4"}),e.jsxs("span",{children:["ETA: ",G(new Date(s.estimatedDelivery),"PPp")]})]}),s.services&&s.services.length>0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Services: ",s.services.map(le=>{var W;return((W=le.serviceId)==null?void 0:W.name)||"N/A"}).join(", ")]})]}),e.jsxs("div",{className:"sm:text-right space-y-2 flex-shrink-0",children:[e.jsx("div",{className:"text-xl sm:text-2xl font-semibold text-slate-800",children:Ee(Number(s.totalPrice),Y)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:G(new Date(s.createdAt),"MMM d, yyyy")}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[a&&s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&(a==="DELIVERED"?e.jsx(i,{size:"sm",onClick:()=>ee(s._id),children:"Mark as Delivered"}):e.jsxs(i,{size:"sm",onClick:()=>$(s._id,a),children:["Mark as ",a.replace("_"," ")]})),e.jsx(A,{to:`${b}/jobs/${s._id}`,className:"min-h-[40px] flex items-center",children:e.jsxs(i,{size:"sm",variant:"outline",className:"w-full sm:w-auto gap-1",children:[e.jsx(q,{className:"h-4 w-4"}),"View details"]})})]})]})]})})},s._id)}),f.length===0&&!k&&e.jsx(v,{children:e.jsxs(N,{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:u||m!=="ALL"?"No jobs match your search or filter.":"No jobs found"}),u||m!=="ALL"?e.jsx(i,{className:"mt-4",variant:"outline",onClick:()=>{E(""),C(""),D("ALL"),x(1)},children:"Clear filters"}):e.jsx(A,{to:`${b}/jobs/new`,children:e.jsxs(i,{className:"mt-4",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Create First Job"]})})]})})]}),e.jsx(je,{open:X,onOpenChange:s=>{p(s),s||w(null),j([])},children:e.jsxs(ve,{children:[e.jsxs(Ne,{children:[e.jsx(be,{children:"Mark as Delivered"}),e.jsx(ye,{children:"Upload at least 2 after photos of the car. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(De,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:se,disabled:O,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),O&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),g.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((s,a)=>e.jsx("img",{src:s,alt:`After ${a+1}`,className:"h-16 w-16 object-cover rounded border"},a))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(i,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsx(i,{onClick:ae,disabled:g.length<2||J,children:J?"Updating...":"Confirm Delivered"})]})]})})]})}),h.totalPages>1&&e.jsx(v,{children:e.jsx(N,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",f.length===0?0:(d-1)*I+1,"–",(d-1)*I+f.length," of ",h.total," jobs"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>z(d-1),disabled:d<=1,children:[e.jsx(we,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs("span",{className:"text-sm px-2",children:["Page ",d," of ",h.totalPages]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>z(d+1),disabled:d>=h.totalPages,children:["Next",e.jsx(q,{className:"h-4 w-4 ml-1"})]})]})]})})})]})}export{Fe as default};
