import{i as De,q as Ne,n as Ee,r as m,a as O,u as i,j as e,V as we,k as ne,f as u,A as ye,C as j,b as v,c as D,e as N,h as Se,s as Ie,l as Ce,d as oe,M as ie}from"./index-o_2gjTLu.js";import{U as ke,c as Ae,u as Te}from"./UploadOverlay-CNbmIMY9.js";import{u as Re}from"./usePortalPath-Bu-7VQPQ.js";import{B as Le}from"./badge-DECccTTd.js";import{S as We,a as Pe,b as Oe,c as Ve,d as Ue}from"./select-Bb9Oo39L.js";import{D as _e,a as $e,b as Me,c as Ke,d as Be,f as Fe}from"./dialog-7kLME1aO.js";import{f as de}from"./currencyUtils-CJd_f-r_.js";import{f as ce}from"./format-B3XKS-z2.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=De("Star",[["polygon",{points:"12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2",key:"8f66p6"}]]),Ge={RECEIVED:"received",WORK_STARTED:"workStarted",COMPLETED:"completed",DELIVERED:"delivered"};function qe(d){return!d||typeof d!="string"?"":d.replace(/\D/g,"").trim()}function ze(d,{name:E="",vehicleNumber:f="",token:s="",beforeImagesLink:I="",afterImagesLink:r=""}){return d?d.replace(/\{\{name\}\}/g,String(E)).replace(/\{\{vehicleNumber\}\}/g,String(f)).replace(/\{\{token\}\}/g,String(s)).replace(/\{\{beforeImagesLink\}\}/g,String(I)).replace(/\{\{afterImagesLink\}\}/g,String(r)):""}const He={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},Ye=[{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}];function ns(){var B,F,J,G,q,z,H,Y,Q,X,Z,ee,se,ae,te;const{id:d}=Ne(),E=Ee(),f=Re(),[s,I]=m.useState(null),[r,V]=m.useState(null),[me,ue]=m.useState(!0),[x,U]=m.useState(!1),[w,C]=m.useState(""),[pe,h]=m.useState(!1),[g,k]=m.useState([]),[A,_]=m.useState(!1);m.useEffect(()=>{d&&$()},[d]);const $=async()=>{var a,t,n;try{const[l,o]=await Promise.all([O.get(`/admin/jobs/${d}`),O.get("/admin/settings").catch(()=>({data:{}}))]);l.data.success?(I(l.data.job),C(l.data.job.status)):(i.error("Failed to load job"),E(`${f}/jobs`)),(a=o==null?void 0:o.data)!=null&&a.success&&o.data.settings?V(o.data.settings):V({})}catch(l){i.error(((n=(t=l.response)==null?void 0:t.data)==null?void 0:n.message)||"Failed to load job"),E(`${f}/jobs`)}finally{ue(!1)}},he=()=>$(),T=async(a,t=null)=>{var l,o;const n=a??w;if(!(!n||n===s.status)){if(n==="DELIVERED"&&(!t||t.length<2)){h(!0);return}U(!0);try{const c={status:n};t!=null&&t.length&&(c.afterImages=t),(await O.patch(`/admin/jobs/${d}/status`,c)).data.success?(i.success("Job status updated successfully!"),C(n),h(!1),k([]),he()):i.error("Failed to update job status")}catch(c){i.error(((o=(l=c.response)==null?void 0:l.data)==null?void 0:o.message)||"Failed to update job status")}finally{U(!1)}}},fe=async a=>{var n;const t=a.target.files;if(!(t!=null&&t.length)||t.length<2){i.error("Please select at least 2 after images");return}if(t.length>4){i.error("Maximum 4 images allowed");return}_(!0);try{const l=await Ae(t),o=new FormData;o.append("folder","after"),l.forEach(y=>o.append("images",y));const c=await Te(o);(n=c==null?void 0:c.urls)!=null&&n.length?(k(c.urls),i.success("Images uploaded")):i.error("Upload failed")}catch(l){i.error((l==null?void 0:l.message)||"Image upload failed")}finally{_(!1)}},xe=()=>{if(g.length<2){i.error("Please upload at least 2 after images");return}T("DELIVERED",g)},ge=((B=s==null?void 0:s.customerId)==null?void 0:B.whatsappNumber)||((F=s==null?void 0:s.customerId)==null?void 0:F.phone)||"",p=qe(ge),R=!!((J=r==null?void 0:r.shopWhatsappNumber)!=null&&J.trim()),be=(r==null?void 0:r.whatsappTemplates)||{},M=s?Ge[s.status]:null,L=M&&be[M]||"",W=R&&p&&L,K=()=>{var re,le;if(!W)return;const a=((re=s.customerId)==null?void 0:re.name)||"",t=((le=s.carId)==null?void 0:le.carNumber)||"",n=s.tokenNumber||"",l=s.beforeImages&&s.beforeImages.length?s.beforeImages[0]:"",o=s.afterImages&&s.afterImages.length?s.afterImages[0]:"",c=s.beforeImages&&s.beforeImages.length?s.beforeImages.join(`
`):"",y=s.afterImages&&s.afterImages.length?s.afterImages.join(`
`):"";let P=ze(L,{name:a,vehicleNumber:t,token:n,beforeImagesLink:c,afterImagesLink:y});if(s.status==="DELIVERED"&&(l||o)){const S=[];l&&S.push(`Before photos: ${l}`),o&&S.push(`After photos: ${o}`),S.length&&(P=P.trimEnd()+`

`+S.join(`
`))}const ve=`https://wa.me/${p}?text=${encodeURIComponent(P)}`;window.open(ve,"_blank","noopener,noreferrer"),i.success("WhatsApp opened. Send the message to the customer.")},je=()=>{var l;const a=(l=r==null?void 0:r.googleReviewLink)==null?void 0:l.trim();if(!a){i.error("Google Review link not set. Add it in WhatsApp Settings.");return}if(!p){i.error("Customer phone number is missing.");return}const t=`Thank you for choosing us ðŸ™
Please leave us a Google review: ${a}`,n=`https://wa.me/${p}?text=${encodeURIComponent(t)}`;window.open(n,"_blank","noopener,noreferrer"),i.success("WhatsApp opened. Send the review request to the customer.")};if(me)return e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(we,{size:"section"})});if(!s)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{children:"Job not found"}),e.jsx(ne,{to:`${f}/jobs`,children:e.jsx(u,{children:"Back to Jobs"})})]});const b=(a=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[a])(s.status);return e.jsxs(e.Fragment,{children:[e.jsx(ke,{show:A,message:"Uploading imagesâ€¦"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx(ne,{to:"/admin/jobs",className:"min-h-[44px] min-w-[44px] flex items-center justify-center",children:e.jsx(u,{variant:"ghost",size:"icon",children:e.jsx(ye,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-slate-800",children:"Job Details"}),e.jsxs("p",{className:"text-muted-foreground text-sm",children:["Token: ",s.tokenNumber]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs(j,{children:[e.jsx(v,{children:e.jsx(D,{children:"Job Information"})}),e.jsxs(N,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Status"}),e.jsx(Le,{className:Se("rounded-md",He[s.status]||""),children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Token Number"}),e.jsx("span",{className:"font-medium text-slate-800",children:s.tokenNumber})]}),s.assignedTo&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Assigned to"}),e.jsxs("span",{className:"font-medium text-slate-800",children:[s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]})]}),e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Total Price"}),e.jsx("span",{className:"text-xl font-semibold text-primary",children:de(Number(s.totalPrice),r==null?void 0:r.currency)})]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Estimated Delivery"}),e.jsx("span",{className:"font-medium",children:ce(new Date(s.estimatedDelivery),"PPp")})]}),s.actualDelivery&&e.jsxs("div",{className:"flex items-center justify-between py-1 border-b border-border/60",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Actual Delivery"}),e.jsx("span",{className:"font-medium",children:ce(new Date(s.actualDelivery),"PPp")})]})]})]}),e.jsxs(j,{children:[e.jsx(v,{children:e.jsx(D,{children:"Customer & Car"})}),e.jsxs(N,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(G=s.customerId)==null?void 0:G.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:(q=s.customerId)==null?void 0:q.phone})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:(z=s.carId)==null?void 0:z.carNumber}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[(H=s.carId)==null?void 0:H.brand," ",(Y=s.carId)==null?void 0:Y.model," ",((Q=s.carId)==null?void 0:Q.color)&&`â€¢ ${s.carId.color}`]})]})]})]})]}),e.jsxs(j,{className:"md:col-span-2",children:[e.jsx(v,{children:e.jsx(D,{children:"Services"})}),e.jsx(N,{children:e.jsx("div",{className:"space-y-2",children:s.services&&s.services.map((a,t)=>{var n;return e.jsxs("div",{className:"flex items-center justify-between py-2 px-2 border-b border-border/60 last:border-0 rounded-md hover:bg-muted/50 transition-colors",children:[e.jsx("span",{className:"text-slate-700",children:((n=a.serviceId)==null?void 0:n.name)||"Service"}),e.jsx("span",{className:"font-medium text-slate-800",children:de(Number(a.price),r==null?void 0:r.currency)})]},t)})})})]}),(((X=s.beforeImages)==null?void 0:X.length)>0||((Z=s.afterImages)==null?void 0:Z.length)>0)&&e.jsxs(j,{className:"md:col-span-2",children:[e.jsxs(v,{children:[e.jsx(D,{children:"Job photos"}),e.jsx(oe,{children:"Before and after images of the car"})]}),e.jsxs(N,{className:"space-y-6",children:[((ee=s.beforeImages)==null?void 0:ee.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Before"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.beforeImages.map((a,t)=>e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:a,alt:`Before ${t+1}`,className:"h-32 w-auto object-cover"})},t))})]}),((se=s.afterImages)==null?void 0:se.length)>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-2",children:"After"}),e.jsx("div",{className:"flex flex-wrap gap-3",children:s.afterImages.map((a,t)=>e.jsx("a",{href:a,target:"_blank",rel:"noopener noreferrer",className:"block rounded-lg overflow-hidden border border-border hover:opacity-90 transition-opacity",children:e.jsx("img",{src:a,alt:`After ${t+1}`,className:"h-32 w-auto object-cover"})},t))})]})]})]}),e.jsxs(j,{className:"md:col-span-2",children:[e.jsxs(v,{children:[e.jsx(D,{children:"Status & WhatsApp"}),e.jsx(oe,{children:"Update job status and send status messages to the customer via WhatsApp (click-to-chat)."})]}),e.jsxs(N,{className:"space-y-4",children:[s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(We,{value:w,onValueChange:C,children:[e.jsx(Pe,{className:"w-full sm:flex-1",children:e.jsx(Oe,{})}),e.jsx(Ve,{children:Ye.filter(a=>s.status==="RECEIVED"?a.value==="WORK_STARTED":s.status==="WORK_STARTED"?a.value==="COMPLETED":s.status==="COMPLETED"?a.value==="DELIVERED":!1).map(a=>e.jsx(Ue,{value:a.value,children:a.label},a.value))})]}),e.jsx(u,{onClick:()=>w==="DELIVERED"?h(!0):T(),disabled:x||w===s.status,className:"w-full sm:w-auto",children:x?"Updating...":"Update Status"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(u,{onClick:()=>b==="DELIVERED"?h(!0):T(b),disabled:x,className:"w-full sm:flex-1",children:[b==="WORK_STARTED"&&"â–¶ Mark Work Started",b==="COMPLETED"&&"âœ… Mark Completed",b==="DELIVERED"&&"ðŸš— Mark Delivered"]}),e.jsxs(u,{variant:"outline",onClick:K,disabled:!W,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:R?p?L?"Open WhatsApp with pre-filled message":"Template empty in WhatsApp Settings":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Send ",s.status.replace("_"," ")," WhatsApp"]})]})]}),s.status==="DELIVERED"&&e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsxs(u,{variant:"outline",onClick:K,disabled:!W,className:"w-full sm:flex-1 bg-[#25D366]/10 text-[#25D366] hover:bg-[#25D366]/20 border-[#25D366]/30",title:R?p?"Open WhatsApp":"Customer phone missing":"Add Shop WhatsApp number in WhatsApp Settings",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Send Delivered WhatsApp"]}),e.jsxs(u,{onClick:je,disabled:!p||!((ae=r==null?void 0:r.googleReviewLink)!=null&&ae.trim()),className:"w-full sm:flex-1 bg-amber-50 text-amber-700 hover:bg-amber-100 border border-amber-200",title:(te=r==null?void 0:r.googleReviewLink)!=null&&te.trim()?"Open WhatsApp with review request":"Add Google Review link in WhatsApp Settings",children:[e.jsx(Je,{className:"h-4 w-4 mr-2"}),"Ask for Google Review"]})]})]})]}),e.jsx(_e,{open:pe,onOpenChange:a=>{h(a),a||k([])},children:e.jsxs($e,{children:[e.jsxs(Me,{children:[e.jsx(Ke,{children:"Mark as Delivered"}),e.jsx(Be,{children:"Upload at least 2 after photos of the car. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(Fe,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:fe,disabled:A,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),A&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploadingâ€¦"}),g.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((a,t)=>e.jsx("img",{src:a,alt:`After ${t+1}`,className:"h-16 w-16 object-cover rounded border"},t))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>h(!1),children:"Cancel"}),e.jsx(u,{onClick:xe,disabled:g.length<2||x,children:x?"Updating...":"Confirm Delivered"})]})]})})]})})]})]})]})}export{ns as default};
