import{n as re,o as ie,r,a as L,u as i,j as e,V as ne,k as A,f as n,P as B,C as v,e as N,I as ce,l as oe}from"./index-BW20lZeO.js";import{M as de,u as me}from"./uploadImages-BbuQiL50.js";import{u as ue}from"./usePortalPath-fDGWwlGx.js";import{B as xe}from"./badge-Cyx4j5sX.js";import{S as he,a as ge,b as fe,c as pe,d as je}from"./select-rIuRCf4V.js";import{D as ve,a as Ne,b as be,c as Ee,d as ye,f as De}from"./dialog-DFhCNs-i.js";import{f as Ce}from"./currencyUtils-CJd_f-r_.js";import{S as K}from"./search-BGL9Yz2T.js";import{C as Se}from"./clock-9vbjEKTN.js";import{a as G,C as we}from"./chevron-right-C5NbmIo2.js";import{f as Z}from"./format-B3XKS-z2.js";const Le={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},Ae=[{value:"ALL",label:"All Statuses"},{value:"RECEIVED",label:"Received"},{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}],I=10;function Ue(){re();const b=ue(),{user:E}=ie(s=>s.auth),P=(E==null?void 0:E.role)==="EMPLOYEE",[f,q]=r.useState([]),[k,T]=r.useState(!0),[m,y]=r.useState("ALL"),[u,D]=r.useState(""),[R,C]=r.useState(""),[H,X]=r.useState("USD"),[d,x]=r.useState(1),[h,Y]=r.useState({total:0,totalPages:0}),[Q,p]=r.useState(!1),[M,S]=r.useState(null),[g,j]=r.useState([]),[O,V]=r.useState(!1),[_,J]=r.useState(!1);r.useEffect(()=>{F()},[m,u,d]),r.useEffect(()=>{L.get("/admin/settings").then(s=>{var a,l;(a=s.data)!=null&&a.success&&((l=s.data.settings)!=null&&l.currency)&&X(s.data.settings.currency)}).catch(()=>{})},[]);const F=async()=>{var s,a;T(!0);try{const l=new URLSearchParams;l.set("status",m),l.set("page",String(d)),l.set("limit",String(I)),u.trim()&&l.set("search",u.trim());const t=await L.get(`/admin/jobs?${l.toString()}`);t.data.success?(q(t.data.jobs||[]),t.data.pagination&&Y({total:t.data.pagination.total,totalPages:t.data.pagination.totalPages})):i.error("Failed to load jobs")}catch(l){i.error(((a=(s=l.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to load jobs")}finally{T(!1)}},U=s=>{s==null||s.preventDefault(),D(R),x(1)},z=s=>{s<1||s>h.totalPages||x(s)},$=async(s,a,l=null)=>{var t,o;try{const c={status:a};l!=null&&l.length&&(c.afterImages=l),(await L.patch(`/admin/jobs/${s}/status`,c)).data.success?(i.success("Job status updated successfully!"),F()):i.error("Failed to update job status")}catch(c){i.error(((o=(t=c.response)==null?void 0:t.data)==null?void 0:o.message)||"Failed to update job status")}},ee=s=>{S(s),j([]),p(!0)},se=async s=>{var l;const a=s.target.files;if(!(a!=null&&a.length)||a.length<2){i.error("Please select at least 2 after images");return}if(a.length>4){i.error("Maximum 4 images allowed");return}for(let t=0;t<a.length;t++)if(a[t].size>de){i.error("One or more images are too large. Use images under 12MB each.");return}V(!0);try{const t=new FormData;t.append("folder","after");for(let c=0;c<a.length;c++)t.append("images",a[c]);const o=await me(t);(l=o==null?void 0:o.urls)!=null&&l.length?(j(o.urls),i.success("Images uploaded")):i.error("Upload failed")}catch(t){i.error((t==null?void 0:t.message)||"Image upload failed")}finally{V(!1)}},ae=async()=>{if(!M||g.length<2){i.error("Please upload at least 2 after images");return}J(!0);try{await $(M,"DELIVERED",g),p(!1),S(null),j([])}finally{J(!1)}},te=s=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[s];return k?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(ne,{size:"section"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-foreground",children:P?"My Jobs":"Jobs"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:P?"Jobs assigned to you. Create new jobs or manage status and delivery.":"Manage all car wash jobs. Open a job to update status and send WhatsApp messages to the customer."})]}),e.jsx(A,{to:`${b}/jobs/new`,className:"min-h-[44px] flex items-center",children:e.jsxs(n,{className:"w-full sm:w-auto gap-2",children:[e.jsx(B,{className:"h-4 w-4"}),"New Job"]})})]}),e.jsx(v,{children:e.jsx(N,{className:"p-6",children:e.jsxs("form",{onSubmit:U,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-2 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(K,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ce,{placeholder:"Search by token, customer name, phone, or car number...",value:R,onChange:s=>C(s.target.value),onKeyDown:s=>s.key==="Enter"&&U(s),className:"pl-9"})]}),e.jsx(n,{type:"submit",variant:"secondary",size:"icon",className:"shrink-0 h-10 w-10",title:"Search",children:e.jsx(K,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs(he,{value:m,onValueChange:s=>{y(s),x(1)},children:[e.jsx(ge,{className:"w-[180px]",children:e.jsx(fe,{placeholder:"Status"})}),e.jsx(pe,{children:Ae.map(s=>e.jsx(je,{value:s.value,children:s.label},s.value))})]}),(u||m!=="ALL")&&e.jsx(n,{type:"button",variant:"ghost",size:"sm",onClick:()=>{D(""),C(""),y("ALL"),x(1)},children:"Clear"})]})]})})}),e.jsxs("div",{className:"grid gap-4",children:[f.map(s=>{var l,t,o,c,w;const a=te(s.status);return e.jsx(v,{className:"transition-shadow duration-150",children:e.jsx(N,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Token: ",s.tokenNumber]}),e.jsx(xe,{className:Le[s.status]||"",children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsx("span",{children:(l=s.carId)==null?void 0:l.carNumber}),((t=s.carId)==null?void 0:t.brand)&&((o=s.carId)==null?void 0:o.model)&&e.jsxs("span",{children:["• ",s.carId.brand," ",s.carId.model]})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Customer:"})," ",(c=s.customerId)==null?void 0:c.name," • ",(w=s.customerId)==null?void 0:w.phone]}),s.assignedTo&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Assigned to: ",s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Se,{className:"h-4 w-4"}),e.jsxs("span",{children:["ETA: ",Z(new Date(s.estimatedDelivery),"PPp")]})]}),s.services&&s.services.length>0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Services: ",s.services.map(le=>{var W;return((W=le.serviceId)==null?void 0:W.name)||"N/A"}).join(", ")]})]}),e.jsxs("div",{className:"sm:text-right space-y-2 flex-shrink-0",children:[e.jsx("div",{className:"text-xl sm:text-2xl font-semibold text-slate-800",children:Ce(Number(s.totalPrice),H)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:Z(new Date(s.createdAt),"MMM d, yyyy")}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[a&&s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&(a==="DELIVERED"?e.jsx(n,{size:"sm",onClick:()=>ee(s._id),children:"Mark as Delivered"}):e.jsxs(n,{size:"sm",onClick:()=>$(s._id,a),children:["Mark as ",a.replace("_"," ")]})),e.jsx(A,{to:`${b}/jobs/${s._id}`,className:"min-h-[40px] flex items-center",children:e.jsxs(n,{size:"sm",variant:"outline",className:"w-full sm:w-auto gap-1",children:[e.jsx(G,{className:"h-4 w-4"}),"View details"]})})]})]})]})})},s._id)}),f.length===0&&!k&&e.jsx(v,{children:e.jsxs(N,{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:u||m!=="ALL"?"No jobs match your search or filter.":"No jobs found"}),u||m!=="ALL"?e.jsx(n,{className:"mt-4",variant:"outline",onClick:()=>{D(""),C(""),y("ALL"),x(1)},children:"Clear filters"}):e.jsx(A,{to:`${b}/jobs/new`,children:e.jsxs(n,{className:"mt-4",children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Create First Job"]})})]})})]}),e.jsx(ve,{open:Q,onOpenChange:s=>{p(s),s||S(null),j([])},children:e.jsxs(Ne,{children:[e.jsxs(be,{children:[e.jsx(Ee,{children:"Mark as Delivered"}),e.jsx(ye,{children:"Upload at least 2 after photos of the car. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(De,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:se,disabled:O,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),O&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),g.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:g.map((s,a)=>e.jsx("img",{src:s,alt:`After ${a+1}`,className:"h-16 w-16 object-cover rounded border"},a))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(n,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsx(n,{onClick:ae,disabled:g.length<2||_,children:_?"Updating...":"Confirm Delivered"})]})]})})]})}),h.totalPages>1&&e.jsx(v,{children:e.jsx(N,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",f.length===0?0:(d-1)*I+1,"–",(d-1)*I+f.length," of ",h.total," jobs"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>z(d-1),disabled:d<=1,children:[e.jsx(we,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs("span",{className:"text-sm px-2",children:["Page ",d," of ",h.totalPages]}),e.jsxs(n,{variant:"outline",size:"sm",onClick:()=>z(d+1),disabled:d>=h.totalPages,children:["Next",e.jsx(G,{className:"h-4 w-4 ml-1"})]})]})]})})})]})}export{Ue as default};
