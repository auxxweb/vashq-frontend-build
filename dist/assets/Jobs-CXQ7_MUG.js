import{n as te,o as le,r as t,a as A,u as m,j as e,V as re,k as I,f as r,P as B,C as v,e as N,I as ne,l as ie}from"./index-D5eo3nMI.js";import{M as ce,a as oe,b}from"./MultiImageUpload-Wwfmm4Gr.js";import{u as de}from"./usePortalPath-kWBXknMv.js";import{B as me}from"./badge-ajqDAm-k.js";import{S as ue,a as xe,b as he,c as pe,d as ge}from"./select-CN9qpzQy.js";import{D as fe,a as je,b as ve,c as Ne,d as be,f as Ee}from"./dialog-B4ZJCXOO.js";import{f as ye}from"./currencyUtils-CJd_f-r_.js";import{S as U}from"./search-C13wP6f9.js";import{C as De}from"./clock-D1mc0Irk.js";import{a as K,C as Ce}from"./chevron-right-AUpDwJYQ.js";import{f as G}from"./format-B3XKS-z2.js";const Se={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},we=[{value:"ALL",label:"All Statuses"},{value:"RECEIVED",label:"Received"},{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}],P=10;function Je(){te();const E=de(),{user:y}=le(s=>s.auth),k=(y==null?void 0:y.role)==="EMPLOYEE",[p,q]=t.useState([]),[T,R]=t.useState(!0),[o,D]=t.useState("ALL"),[d,C]=t.useState(""),[M,S]=t.useState(""),[H,X]=t.useState("USD"),[i,u]=t.useState(1),[x,Y]=t.useState({total:0,totalPages:0}),[Z,g]=t.useState(!1),[O,w]=t.useState(null),[f,j]=t.useState([]),[_,V]=t.useState(!1);t.useEffect(()=>{J()},[o,d,i]),t.useEffect(()=>{A.get("/admin/settings").then(s=>{var l,a;(l=s.data)!=null&&l.success&&((a=s.data.settings)!=null&&a.currency)&&X(s.data.settings.currency)}).catch(()=>{})},[]);const J=async()=>{var s,l;R(!0);try{const a=new URLSearchParams;a.set("status",o),a.set("page",String(i)),a.set("limit",String(P)),d.trim()&&a.set("search",d.trim());const n=await A.get(`/admin/jobs?${a.toString()}`);n.data.success?(q(n.data.jobs||[]),n.data.pagination&&Y({total:n.data.pagination.total,totalPages:n.data.pagination.totalPages})):m.error("Failed to load jobs")}catch(a){m.error(((l=(s=a.response)==null?void 0:s.data)==null?void 0:l.message)||"Failed to load jobs")}finally{R(!1)}},F=s=>{s==null||s.preventDefault(),C(M),u(1)},z=s=>{s<1||s>x.totalPages||u(s)},$=async(s,l,a=null)=>{var n,h;try{const c={status:l};a!=null&&a.length&&(c.afterImages=a),(await A.patch(`/admin/jobs/${s}/status`,c)).data.success?(m.success("Job status updated successfully!"),J()):m.error("Failed to update job status")}catch(c){m.error(((h=(n=c.response)==null?void 0:n.data)==null?void 0:h.message)||"Failed to update job status")}},Q=s=>{w(s),j([]),g(!0)},ee=async()=>{if(!O||f.length<b){m.error(`Please upload at least ${b} after images`);return}V(!0);try{await $(O,"DELIVERED",f),g(!1),w(null),j([])}finally{V(!1)}},se=s=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[s];return T?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(re,{size:"section"})}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-foreground",children:k?"My Jobs":"Jobs"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:k?"Jobs assigned to you. Create new jobs or manage status and delivery.":"Manage all car wash jobs. Open a job to update status and send WhatsApp messages to the customer."})]}),e.jsx(I,{to:`${E}/jobs/new`,className:"min-h-[44px] flex items-center",children:e.jsxs(r,{className:"w-full sm:w-auto gap-2",children:[e.jsx(B,{className:"h-4 w-4"}),"New Job"]})})]}),e.jsx(v,{children:e.jsx(N,{className:"p-6",children:e.jsxs("form",{onSubmit:F,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-2 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(U,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ne,{placeholder:"Search by token, customer name, phone, or car number...",value:M,onChange:s=>S(s.target.value),onKeyDown:s=>s.key==="Enter"&&F(s),className:"pl-9"})]}),e.jsx(r,{type:"submit",variant:"secondary",size:"icon",className:"shrink-0 h-10 w-10",title:"Search",children:e.jsx(U,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs(ue,{value:o,onValueChange:s=>{D(s),u(1)},children:[e.jsx(xe,{className:"w-[180px]",children:e.jsx(he,{placeholder:"Status"})}),e.jsx(pe,{children:we.map(s=>e.jsx(ge,{value:s.value,children:s.label},s.value))})]}),(d||o!=="ALL")&&e.jsx(r,{type:"button",variant:"ghost",size:"sm",onClick:()=>{C(""),S(""),D("ALL"),u(1)},children:"Clear"})]})]})})}),e.jsxs("div",{className:"grid gap-4",children:[p.map(s=>{var a,n,h,c,L;const l=se(s.status);return e.jsx(v,{className:"transition-shadow duration-150",children:e.jsx(N,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Token: ",s.tokenNumber]}),e.jsx(me,{className:Se[s.status]||"",children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(ie,{className:"h-4 w-4"}),e.jsx("span",{children:(a=s.carId)==null?void 0:a.carNumber}),((n=s.carId)==null?void 0:n.brand)&&((h=s.carId)==null?void 0:h.model)&&e.jsxs("span",{children:["• ",s.carId.brand," ",s.carId.model]})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Customer:"})," ",(c=s.customerId)==null?void 0:c.name," • ",(L=s.customerId)==null?void 0:L.phone]}),s.assignedTo&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Assigned to: ",s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(De,{className:"h-4 w-4"}),e.jsxs("span",{children:["ETA: ",G(new Date(s.estimatedDelivery),"PPp")]})]}),s.services&&s.services.length>0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Services: ",s.services.map(ae=>{var W;return((W=ae.serviceId)==null?void 0:W.name)||"N/A"}).join(", ")]})]}),e.jsxs("div",{className:"sm:text-right space-y-2 flex-shrink-0",children:[e.jsx("div",{className:"text-xl sm:text-2xl font-semibold text-slate-800",children:ye(Number(s.totalPrice),H)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:G(new Date(s.createdAt),"MMM d, yyyy")}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[l&&s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&(l==="DELIVERED"?e.jsx(r,{size:"sm",onClick:()=>Q(s._id),children:"Mark as Delivered"}):e.jsxs(r,{size:"sm",onClick:()=>$(s._id,l),children:["Mark as ",l.replace("_"," ")]})),e.jsx(I,{to:`${E}/jobs/${s._id}`,className:"min-h-[40px] flex items-center",children:e.jsxs(r,{size:"sm",variant:"outline",className:"w-full sm:w-auto gap-1",children:[e.jsx(K,{className:"h-4 w-4"}),"View details"]})})]})]})]})})},s._id)}),p.length===0&&!T&&e.jsx(v,{children:e.jsxs(N,{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:d||o!=="ALL"?"No jobs match your search or filter.":"No jobs found"}),d||o!=="ALL"?e.jsx(r,{className:"mt-4",variant:"outline",onClick:()=>{C(""),S(""),D("ALL"),u(1)},children:"Clear filters"}):e.jsx(I,{to:`${E}/jobs/new`,children:e.jsxs(r,{className:"mt-4",children:[e.jsx(B,{className:"mr-2 h-4 w-4"}),"Create First Job"]})})]})})]}),e.jsx(fe,{open:Z,onOpenChange:s=>{g(s),s||w(null),j([])},children:e.jsxs(je,{children:[e.jsxs(ve,{children:[e.jsx(Ne,{children:"Mark as Delivered"}),e.jsx(be,{children:"Upload at least 2 after photos of the car. Add one by one from camera or gallery. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(Ee,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx(ce,{value:f,onChange:j,folder:"after",minImages:b,maxImages:oe,label:"",description:"Add after photos one by one. Minimum 2, maximum 4.",thumbnailClassName:"h-16 w-16 object-cover rounded border"}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(r,{variant:"outline",onClick:()=>g(!1),children:"Cancel"}),e.jsx(r,{onClick:ee,disabled:f.length<b||_,children:_?"Updating...":"Confirm Delivered"})]})]})})]})}),x.totalPages>1&&e.jsx(v,{children:e.jsx(N,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",p.length===0?0:(i-1)*P+1,"–",(i-1)*P+p.length," of ",x.total," jobs"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>z(i-1),disabled:i<=1,children:[e.jsx(Ce,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs("span",{className:"text-sm px-2",children:["Page ",i," of ",x.totalPages]}),e.jsxs(r,{variant:"outline",size:"sm",onClick:()=>z(i+1),disabled:i>=x.totalPages,children:["Next",e.jsx(K,{className:"h-4 w-4 ml-1"})]})]})]})})})]})})}export{Je as default};
