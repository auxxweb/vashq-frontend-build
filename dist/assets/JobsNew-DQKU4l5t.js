import{n as je,o as ye,r as d,a as j,u as i,j as e,V as be,k as ee,f as v,A as ve,p as Ne,C as N,b as A,c as _,e as $,L as g,P as se,I as y}from"./index-DmDksVhj.js";import{u as Ce}from"./usePortalPath-BGKdhB00.js";import{S as E,a as L,b as U,c as q,d as k}from"./select-BrD8s0Ad.js";import{f as Ie}from"./currencyUtils-CJd_f-r_.js";function Ae(){const ae=je(),F=Ce(),{user:x}=ye(s=>s.auth),[te,B]=d.useState([]),[re,V]=d.useState([]),[H,ce]=d.useState([]),[le,ie]=d.useState("USD"),[ne,oe]=d.useState(!0),[J,W]=d.useState(!1),[a,u]=d.useState({customerId:"",carId:"",serviceIds:[],beforeImages:[],estimatedDelivery:null,notes:"",assignedTo:""}),[z,de]=d.useState([]),[Y,K]=d.useState(!1),[b,T]=d.useState({name:"",phone:"",whatsappNumber:"",email:""}),[f,C]=d.useState({carNumber:"",brand:"",model:"",color:""}),[O,G]=d.useState(!1),[Q,R]=d.useState(!1);d.useEffect(()=>{me()},[x==null?void 0:x.role]),d.useEffect(()=>{a.customerId&&ue(a.customerId)},[a.customerId]);const me=async()=>{var s,t,l,c,r,n,h;try{const m=[j.get("/admin/customers"),j.get("/admin/services"),j.get("/admin/settings").catch(()=>({data:{}}))];(x==null?void 0:x.role)==="CAR_WASH_ADMIN"&&m.push(j.get("/admin/employees").catch(()=>({data:{success:!1,employees:[]}})));const o=await Promise.all(m),p=(s=o[0])==null?void 0:s.data,S=(t=o[1])==null?void 0:t.data,w=(l=o[2])==null?void 0:l.data,D=(c=o[3])==null?void 0:c.data;p!=null&&p.success&&Array.isArray(p.customers)&&B(p.customers),S!=null&&S.success&&Array.isArray(S.services)&&ce(S.services.filter(M=>(M==null?void 0:M.isActive)!==!1)),w!=null&&w.success&&((r=w.settings)!=null&&r.currency)&&ie(w.settings.currency),D!=null&&D.success&&Array.isArray(D.employees)&&de(D.employees)}catch(m){i.error(((h=(n=m.response)==null?void 0:n.data)==null?void 0:h.message)||"Failed to load data")}finally{oe(!1)}},ue=async s=>{var t,l,c;if(s)try{const r=await j.get(`/admin/cars?customerId=${encodeURIComponent(s)}`);(t=r==null?void 0:r.data)!=null&&t.success&&Array.isArray(r.data.cars)&&V(r.data.cars)}catch(r){i.error(((c=(l=r.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to load cars")}},he=async()=>{var s,t,l;try{const c=await j.post("/admin/customers",b),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.customer)!=null&&s._id)?(B(n=>[...n,r.customer]),u(n=>({...n,customerId:r.customer._id})),T({name:"",phone:"",whatsappNumber:"",email:""}),G(!1),i.success("Customer created successfully!")):i.error((r==null?void 0:r.message)||"Failed to create customer")}catch(c){i.error(((l=(t=c.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to create customer")}},ge=async()=>{var s,t,l;if(!a.customerId){i.error("Please select a customer first");return}try{const c=await j.post("/admin/cars",{...f,customerId:a.customerId}),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.car)!=null&&s._id)?(V(n=>[...n,r.car]),u(n=>({...n,carId:r.car._id})),C({carNumber:"",brand:"",model:"",color:""}),R(!1),i.success("Car created successfully!")):i.error((r==null?void 0:r.message)||"Failed to create car")}catch(c){i.error(((l=(t=c.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to create car")}},X=s=>{a.serviceIds.includes(s)?u({...a,serviceIds:a.serviceIds.filter(t=>t!==s)}):u({...a,serviceIds:[...a.serviceIds,s]})},Z=H.filter(s=>a.serviceIds.includes(s._id)),I=Z.length>0?(()=>{const s=Z.reduce((l,c)=>l+(c.maxTime??c.minTime??60),0),t=new Date;return t.setMinutes(t.getMinutes()+s),t})():null,xe=async s=>{var l,c,r,n,h;const t=s.target.files;if(t!=null&&t.length){if(t.length<2){i.error("Please select at least 2 before images");return}if(t.length>4){i.error("Maximum 4 images allowed");return}K(!0);try{const m=new FormData;for(let p=0;p<t.length;p++)m.append("images",t[p]);const o=await j.post("/admin/upload/images",m,{timeout:9e4});(l=o.data)!=null&&l.success&&((r=(c=o.data)==null?void 0:c.urls)!=null&&r.length)?(u({...a,beforeImages:o.data.urls}),i.success("Images uploaded")):i.error("Upload failed")}catch(m){i.error(((h=(n=m.response)==null?void 0:n.data)==null?void 0:h.message)||"Image upload failed")}finally{K(!1)}}},fe=s=>{u({...a,beforeImages:a.beforeImages.filter((t,l)=>l!==s)})},P=s=>{if(!s)return"";const t=new Date(s),l=t.getFullYear(),c=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),h=String(t.getMinutes()).padStart(2,"0");return`${l}-${c}-${r}T${n}:${h}`},pe=async s=>{var c,r,n,h,m;if(s.preventDefault(),!a.customerId||!a.carId||a.serviceIds.length===0){i.error("Please fill all required fields");return}if(!((c=a.beforeImages)!=null&&c.length)||a.beforeImages.length<2){i.error("Please upload at least 2 before images of the car");return}const t={customerId:a.customerId,carId:a.carId,serviceIds:a.serviceIds,beforeImages:a.beforeImages,notes:a.notes||""},l=a.estimatedDelivery||I;l&&(t.estimatedDelivery=new Date(l).toISOString()),a.assignedTo&&(t.assignedTo=a.assignedTo),W(!0);try{const o=await j.post("/admin/jobs",t);(r=o==null?void 0:o.data)!=null&&r.success?(i.success("Job created successfully!"),ae(`${F}/jobs`)):i.error(((n=o==null?void 0:o.data)==null?void 0:n.message)||"Failed to create job")}catch(o){i.error(((m=(h=o.response)==null?void 0:h.data)==null?void 0:m.message)||"Failed to create job")}finally{W(!1)}};return ne?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(be,{size:"section"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ee,{to:`${F}/jobs`,children:e.jsx(v,{variant:"ghost",size:"icon",children:e.jsx(ve,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Create New Job"}),e.jsx("p",{className:"text-muted-foreground",children:"Add a new car wash job"})]})]}),e.jsxs("form",{onSubmit:pe,onKeyDown:Ne,className:"space-y-6",children:[e.jsxs(N,{children:[e.jsx(A,{children:e.jsx(_,{children:"Customer & Car"})}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Customer *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(E,{value:a.customerId,onValueChange:s=>u({...a,customerId:s,carId:""}),children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Select customer"})}),e.jsx(q,{children:te.map(s=>e.jsxs(k,{value:s._id,children:[s.name," - ",s.phone]},s._id))})]}),e.jsx(v,{type:"button",variant:"outline",onClick:()=>G(!O),children:e.jsx(se,{className:"h-4 w-4"})})]}),O&&e.jsxs(N,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Name *"}),e.jsx(y,{value:b.name,onChange:s=>T({...b,name:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Phone *"}),e.jsx(y,{value:b.phone,onChange:s=>T({...b,phone:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"WhatsApp Number *"}),e.jsx(y,{value:b.whatsappNumber,onChange:s=>T({...b,whatsappNumber:s.target.value}),required:!0})]}),e.jsx(v,{type:"button",onClick:he,children:"Create Customer"})]})]}),(x==null?void 0:x.role)==="CAR_WASH_ADMIN"&&z.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Assigned to (optional)"}),e.jsxs(E,{value:a.assignedTo,onValueChange:s=>u({...a,assignedTo:s}),children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Select employee"})}),e.jsxs(q,{children:[e.jsx(k,{value:"",children:"Unassigned"}),z.map(s=>e.jsxs(k,{value:s._id,children:[s.name||s.email," (",s.employeeCode,")"]},s._id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Car *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(E,{value:a.carId,onValueChange:s=>u({...a,carId:s}),disabled:!a.customerId,children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Select car"})}),e.jsx(q,{children:re.map(s=>e.jsxs(k,{value:s._id,children:[s.carNumber," ",s.brand&&s.model&&`- ${s.brand} ${s.model}`]},s._id))})]}),e.jsx(v,{type:"button",variant:"outline",onClick:()=>R(!Q),disabled:!a.customerId,children:e.jsx(se,{className:"h-4 w-4"})})]}),Q&&e.jsxs(N,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Car Number *"}),e.jsx(y,{value:f.carNumber,onChange:s=>C({...f,carNumber:s.target.value}),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Brand"}),e.jsx(y,{value:f.brand,onChange:s=>C({...f,brand:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Model"}),e.jsx(y,{value:f.model,onChange:s=>C({...f,model:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(g,{children:"Color"}),e.jsx(y,{value:f.color,onChange:s=>C({...f,color:s.target.value})})]})]}),e.jsx(v,{type:"button",onClick:ge,children:"Create Car"})]})]})]})]}),e.jsxs(N,{children:[e.jsx(A,{children:e.jsx(_,{children:"Services *"})}),e.jsx($,{children:e.jsx("div",{className:"space-y-2",children:H.map(s=>e.jsxs("div",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer ${a.serviceIds.includes(s._id)?"border-primary bg-primary/5":""}`,onClick:()=>X(s._id),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Ie(s.price,le),(s.minTime!=null||s.maxTime!=null)&&e.jsxs(e.Fragment,{children:[" • ",s.minTime!=null&&s.maxTime!=null?`${s.minTime}-${s.maxTime} min`:s.maxTime!=null?`Up to ${s.maxTime} min`:`${s.minTime} min`]})]})]}),e.jsx("input",{type:"checkbox",checked:a.serviceIds.includes(s._id),onChange:()=>X(s._id),className:"h-4 w-4"})]},s._id))})})]}),e.jsx(N,{children:e.jsxs(A,{children:[e.jsx(_,{children:"Estimated delivery (optional to edit)"}),e.jsxs($,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Calculated from selected services. You can change the date/time before creating the job."}),e.jsx(y,{type:"datetime-local",value:a.estimatedDelivery?P(a.estimatedDelivery):I?P(I):"",onChange:s=>{const t=s.target.value;u({...a,estimatedDelivery:t?new Date(t):null})},min:P(new Date)}),I&&!a.estimatedDelivery&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Suggested: ",I.toLocaleString()," (from service times)"]})]})]})}),e.jsx(N,{children:e.jsxs(A,{children:[e.jsx(_,{children:"Before photos (car) *"}),e.jsxs($,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload at least 2 photos of the car before the job. Max 4."}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:xe,disabled:Y,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),Y&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),a.beforeImages.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:a.beforeImages.map((s,t)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s,alt:`Before ${t+1}`,className:"h-20 w-20 object-cover rounded border"}),e.jsx("button",{type:"button",onClick:()=>fe(t),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full w-5 h-5 text-xs",children:"×"})]},t))})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(ee,{to:`${F}/jobs`,children:e.jsx(v,{type:"button",variant:"outline",children:"Cancel"})}),e.jsx(v,{type:"submit",disabled:J,children:J?"Creating...":"Create Job"})]})]})]})}export{Ae as default};
