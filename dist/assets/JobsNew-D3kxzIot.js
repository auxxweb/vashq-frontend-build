import{n as ye,o as be,r as o,a as f,u as n,j as e,V as ve,k as ee,f as x,A as Ne,p as Ce,C as v,b as $,c as k,e as M,L as u,P as se,X as ae,I as p}from"./index-BW20lZeO.js";import{M as Ie,u as we}from"./uploadImages-BbuQiL50.js";import{u as Se}from"./usePortalPath-fDGWwlGx.js";import{S as L,a as q,b as B,c as V,d as F}from"./select-rIuRCf4V.js";import{f as Ae}from"./currencyUtils-CJd_f-r_.js";function Me(){const te=ye(),P=Se(),{user:h}=be(s=>s.auth),[re,z]=o.useState([]),[le,H]=o.useState([]),[J,ce]=o.useState([]),[ie,ne]=o.useState("USD"),[oe,de]=o.useState(!0),[W,O]=o.useState(!1),[t,m]=o.useState({customerId:"",carId:"",serviceIds:[],beforeImages:[],estimatedDelivery:null,notes:"",assignedTo:""}),[X,me]=o.useState([]),[Y,G]=o.useState(!1),[j,_]=o.useState({name:"",phone:"",whatsappNumber:"",email:""}),[g,N]=o.useState({carNumber:"",brand:"",model:"",color:""}),[K,C]=o.useState(!1),[Z,I]=o.useState(!1);o.useEffect(()=>{ue()},[h==null?void 0:h.role]),o.useEffect(()=>{t.customerId&&he(t.customerId)},[t.customerId]);const ue=async()=>{var s,a,c,l,r,i,y;try{const b=[f.get("/admin/customers"),f.get("/admin/services"),f.get("/admin/settings").catch(()=>({data:{}}))];(h==null?void 0:h.role)==="CAR_WASH_ADMIN"&&b.push(f.get("/admin/employees").catch(()=>({data:{success:!1,employees:[]}})));const d=await Promise.all(b),S=(s=d[0])==null?void 0:s.data,A=(a=d[1])==null?void 0:a.data,D=(c=d[2])==null?void 0:c.data,T=(l=d[3])==null?void 0:l.data;S!=null&&S.success&&Array.isArray(S.customers)&&z(S.customers),A!=null&&A.success&&Array.isArray(A.services)&&ce(A.services.filter(U=>(U==null?void 0:U.isActive)!==!1)),D!=null&&D.success&&((r=D.settings)!=null&&r.currency)&&ne(D.settings.currency),T!=null&&T.success&&Array.isArray(T.employees)&&me(T.employees)}catch(b){n.error(((y=(i=b.response)==null?void 0:i.data)==null?void 0:y.message)||"Failed to load data")}finally{de(!1)}},he=async s=>{var a,c,l;if(s)try{const r=await f.get(`/admin/cars?customerId=${encodeURIComponent(s)}`);(a=r==null?void 0:r.data)!=null&&a.success&&Array.isArray(r.data.cars)&&H(r.data.cars)}catch(r){n.error(((l=(c=r.response)==null?void 0:c.data)==null?void 0:l.message)||"Failed to load cars")}},ge=async()=>{var s,a,c;try{const l=await f.post("/admin/customers",j),r=l==null?void 0:l.data;r!=null&&r.success&&((s=r.customer)!=null&&s._id)?(z(i=>[...i,r.customer]),m(i=>({...i,customerId:r.customer._id})),_({name:"",phone:"",whatsappNumber:"",email:""}),C(!1),n.success("Customer created successfully!")):n.error((r==null?void 0:r.message)||"Failed to create customer")}catch(l){n.error(((c=(a=l.response)==null?void 0:a.data)==null?void 0:c.message)||"Failed to create customer")}},xe=async()=>{var s,a,c;if(!t.customerId){n.error("Please select a customer first");return}try{const l=await f.post("/admin/cars",{...g,customerId:t.customerId}),r=l==null?void 0:l.data;r!=null&&r.success&&((s=r.car)!=null&&s._id)?(H(i=>[...i,r.car]),m(i=>({...i,carId:r.car._id})),N({carNumber:"",brand:"",model:"",color:""}),I(!1),n.success("Car created successfully!")):n.error((r==null?void 0:r.message)||"Failed to create car")}catch(l){n.error(((c=(a=l.response)==null?void 0:a.data)==null?void 0:c.message)||"Failed to create car")}},Q=s=>{t.serviceIds.includes(s)?m({...t,serviceIds:t.serviceIds.filter(a=>a!==s)}):m({...t,serviceIds:[...t.serviceIds,s]})},R=J.filter(s=>t.serviceIds.includes(s._id)),w=R.length>0?(()=>{const s=R.reduce((c,l)=>c+(l.maxTime??l.minTime??60),0),a=new Date;return a.setMinutes(a.getMinutes()+s),a})():null,fe=async s=>{var c;const a=s.target.files;if(a!=null&&a.length){if(a.length<2){n.error("Please select at least 2 before images");return}if(a.length>4){n.error("Maximum 4 images allowed");return}for(let l=0;l<a.length;l++)if(a[l].size>Ie){n.error("One or more images are too large. Use images under 12MB each.");return}G(!0);try{const l=new FormData;for(let i=0;i<a.length;i++)l.append("images",a[i]);const r=await we(l);(c=r==null?void 0:r.urls)!=null&&c.length?(m(i=>({...i,beforeImages:r.urls})),n.success("Images uploaded")):n.error("Upload failed")}catch(l){n.error((l==null?void 0:l.message)||"Image upload failed")}finally{G(!1)}}},pe=s=>{m({...t,beforeImages:t.beforeImages.filter((a,c)=>c!==s)})},E=s=>{if(!s)return"";const a=new Date(s),c=a.getFullYear(),l=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),y=String(a.getMinutes()).padStart(2,"0");return`${c}-${l}-${r}T${i}:${y}`},je=async s=>{var l,r,i,y,b;if(s.preventDefault(),!t.customerId||!t.carId||t.serviceIds.length===0){n.error("Please fill all required fields");return}if(!((l=t.beforeImages)!=null&&l.length)||t.beforeImages.length<2){n.error("Please upload at least 2 before images of the car");return}const a={customerId:t.customerId,carId:t.carId,serviceIds:t.serviceIds,beforeImages:t.beforeImages,notes:t.notes||""},c=t.estimatedDelivery||w;c&&(a.estimatedDelivery=new Date(c).toISOString()),t.assignedTo&&(a.assignedTo=t.assignedTo),O(!0);try{const d=await f.post("/admin/jobs",a);(r=d==null?void 0:d.data)!=null&&r.success?(n.success("Job created successfully!"),te(`${P}/jobs`)):n.error(((i=d==null?void 0:d.data)==null?void 0:i.message)||"Failed to create job")}catch(d){n.error(((b=(y=d.response)==null?void 0:y.data)==null?void 0:b.message)||"Failed to create job")}finally{O(!1)}};return oe?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(ve,{size:"section"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ee,{to:`${P}/jobs`,children:e.jsx(x,{variant:"ghost",size:"icon",children:e.jsx(Ne,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Create New Job"}),e.jsx("p",{className:"text-muted-foreground",children:"Add a new car wash job"})]})]}),e.jsxs("form",{onSubmit:je,onKeyDown:Ce,className:"space-y-6",children:[e.jsxs(v,{children:[e.jsx($,{children:e.jsx(k,{children:"Customer & Car"})}),e.jsxs(M,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Customer *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(L,{value:t.customerId,onValueChange:s=>{m(a=>({...a,customerId:s,carId:""})),C(!1)},children:[e.jsx(q,{className:"flex-1",children:e.jsx(B,{placeholder:"Select customer"})}),e.jsx(V,{children:re.map(s=>e.jsxs(F,{value:s._id,children:[s.name," - ",s.phone]},s._id))})]}),e.jsx(x,{type:"button",variant:"outline",onClick:()=>{K?C(!1):(m(s=>({...s,customerId:"",carId:""})),C(!0))},children:e.jsx(se,{className:"h-4 w-4"})})]}),K&&e.jsxs(v,{className:"p-4 space-y-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"New customer"}),e.jsx(x,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>C(!1),"aria-label":"Close",children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Name *"}),e.jsx(p,{value:j.name,onChange:s=>_({...j,name:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Phone *"}),e.jsx(p,{value:j.phone,onChange:s=>_({...j,phone:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"WhatsApp Number *"}),e.jsx(p,{value:j.whatsappNumber,onChange:s=>_({...j,whatsappNumber:s.target.value}),required:!0})]}),e.jsx(x,{type:"button",onClick:ge,children:"Create Customer"})]})]}),(h==null?void 0:h.role)==="CAR_WASH_ADMIN"&&X.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Assigned to (optional)"}),e.jsxs(L,{value:t.assignedTo,onValueChange:s=>m({...t,assignedTo:s}),children:[e.jsx(q,{className:"flex-1",children:e.jsx(B,{placeholder:"Select employee"})}),e.jsxs(V,{children:[e.jsx(F,{value:"",children:"Unassigned"}),X.map(s=>e.jsxs(F,{value:s._id,children:[s.name||s.email," (",s.employeeCode,")"]},s._id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Car *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(L,{value:t.carId,onValueChange:s=>{m(a=>({...a,carId:s})),I(!1)},disabled:!t.customerId,children:[e.jsx(q,{className:"flex-1",children:e.jsx(B,{placeholder:"Select car"})}),e.jsx(V,{children:le.map(s=>e.jsxs(F,{value:s._id,children:[s.carNumber," ",s.brand&&s.model&&`- ${s.brand} ${s.model}`]},s._id))})]}),e.jsx(x,{type:"button",variant:"outline",onClick:()=>{Z?I(!1):(m(s=>({...s,carId:""})),I(!0))},disabled:!t.customerId,children:e.jsx(se,{className:"h-4 w-4"})})]}),Z&&e.jsxs(v,{className:"p-4 space-y-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"New car"}),e.jsx(x,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>I(!1),"aria-label":"Close",children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Car Number *"}),e.jsx(p,{value:g.carNumber,onChange:s=>N({...g,carNumber:s.target.value}),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Brand"}),e.jsx(p,{value:g.brand,onChange:s=>N({...g,brand:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Model"}),e.jsx(p,{value:g.model,onChange:s=>N({...g,model:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Color"}),e.jsx(p,{value:g.color,onChange:s=>N({...g,color:s.target.value})})]})]}),e.jsx(x,{type:"button",onClick:xe,children:"Create Car"})]})]})]})]}),e.jsxs(v,{children:[e.jsx($,{children:e.jsx(k,{children:"Services *"})}),e.jsx(M,{children:e.jsx("div",{className:"space-y-2",children:J.map(s=>e.jsxs("div",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer ${t.serviceIds.includes(s._id)?"border-primary bg-primary/5":""}`,onClick:()=>Q(s._id),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Ae(s.price,ie),(s.minTime!=null||s.maxTime!=null)&&e.jsxs(e.Fragment,{children:[" • ",s.minTime!=null&&s.maxTime!=null?`${s.minTime}-${s.maxTime} min`:s.maxTime!=null?`Up to ${s.maxTime} min`:`${s.minTime} min`]})]})]}),e.jsx("input",{type:"checkbox",checked:t.serviceIds.includes(s._id),onChange:()=>Q(s._id),className:"h-4 w-4"})]},s._id))})})]}),e.jsx(v,{children:e.jsxs($,{children:[e.jsx(k,{children:"Estimated delivery (optional to edit)"}),e.jsxs(M,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Calculated from selected services. You can change the date/time before creating the job."}),e.jsx(p,{type:"datetime-local",value:t.estimatedDelivery?E(t.estimatedDelivery):w?E(w):"",onChange:s=>{const a=s.target.value;m({...t,estimatedDelivery:a?new Date(a):null})},min:E(new Date)}),w&&!t.estimatedDelivery&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Suggested: ",w.toLocaleString()," (from service times)"]})]})]})}),e.jsx(v,{children:e.jsxs($,{children:[e.jsx(k,{children:"Before photos (car) *"}),e.jsxs(M,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload at least 2 photos of the car before the job. Max 4."}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:fe,disabled:Y,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),Y&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),t.beforeImages.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:t.beforeImages.map((s,a)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s,alt:`Before ${a+1}`,className:"h-20 w-20 object-cover rounded border"}),e.jsx("button",{type:"button",onClick:()=>pe(a),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full w-5 h-5 text-xs",children:"×"})]},a))})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(ee,{to:`${P}/jobs`,children:e.jsx(x,{type:"button",variant:"outline",children:"Cancel"})}),e.jsx(x,{type:"submit",disabled:W,children:W?"Creating...":"Create Job"})]})]})]})}export{Me as default};
