import{n as ye,o as be,r as o,a as p,u as n,j as e,V as ve,k as ee,f,A as Ne,p as Ce,C as v,b as $,c as k,e as F,L as h,P as se,X as ae,I as j}from"./index-DqxcJu2F.js";import{U as Ie,c as we,u as Se}from"./UploadOverlay-B1fzoAoL.js";import{u as De}from"./usePortalPath-CIDb3ISR.js";import{S as q,a as B,b as V,c as z,d as P}from"./select-DioDUAlB.js";import{f as Te}from"./currencyUtils-CJd_f-r_.js";function Pe(){const te=ye(),U=De(),{user:x}=be(s=>s.auth),[re,H]=o.useState([]),[ce,J]=o.useState([]),[W,le]=o.useState([]),[ie,ne]=o.useState("USD"),[oe,de]=o.useState(!0),[O,Y]=o.useState(!1),[t,m]=o.useState({customerId:"",carId:"",serviceIds:[],beforeImages:[],estimatedDelivery:null,notes:"",assignedTo:""}),[K,me]=o.useState([]),[M,X]=o.useState(!1),[y,_]=o.useState({name:"",phone:"",whatsappNumber:"",email:""}),[g,N]=o.useState({carNumber:"",brand:"",model:"",color:""}),[G,C]=o.useState(!1),[Q,I]=o.useState(!1);o.useEffect(()=>{ue()},[x==null?void 0:x.role]),o.useEffect(()=>{t.customerId&&he(t.customerId)},[t.customerId]);const ue=async()=>{var s,a,l,c,r,i,u;try{const b=[p.get("/admin/customers"),p.get("/admin/services"),p.get("/admin/settings").catch(()=>({data:{}}))];(x==null?void 0:x.role)==="CAR_WASH_ADMIN"&&b.push(p.get("/admin/employees").catch(()=>({data:{success:!1,employees:[]}})));const d=await Promise.all(b),S=(s=d[0])==null?void 0:s.data,D=(a=d[1])==null?void 0:a.data,T=(l=d[2])==null?void 0:l.data,A=(c=d[3])==null?void 0:c.data;S!=null&&S.success&&Array.isArray(S.customers)&&H(S.customers),D!=null&&D.success&&Array.isArray(D.services)&&le(D.services.filter(L=>(L==null?void 0:L.isActive)!==!1)),T!=null&&T.success&&((r=T.settings)!=null&&r.currency)&&ne(T.settings.currency),A!=null&&A.success&&Array.isArray(A.employees)&&me(A.employees)}catch(b){n.error(((u=(i=b.response)==null?void 0:i.data)==null?void 0:u.message)||"Failed to load data")}finally{de(!1)}},he=async s=>{var a,l,c;if(s)try{const r=await p.get(`/admin/cars?customerId=${encodeURIComponent(s)}`);(a=r==null?void 0:r.data)!=null&&a.success&&Array.isArray(r.data.cars)&&J(r.data.cars)}catch(r){n.error(((c=(l=r.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to load cars")}},xe=async()=>{var s,a,l;try{const c=await p.post("/admin/customers",y),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.customer)!=null&&s._id)?(H(i=>[...i,r.customer]),m(i=>({...i,customerId:r.customer._id})),_({name:"",phone:"",whatsappNumber:"",email:""}),C(!1),n.success("Customer created successfully!")):n.error((r==null?void 0:r.message)||"Failed to create customer")}catch(c){n.error(((l=(a=c.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to create customer")}},ge=async()=>{var s,a,l;if(!t.customerId){n.error("Please select a customer first");return}try{const c=await p.post("/admin/cars",{...g,customerId:t.customerId}),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.car)!=null&&s._id)?(J(i=>[...i,r.car]),m(i=>({...i,carId:r.car._id})),N({carNumber:"",brand:"",model:"",color:""}),I(!1),n.success("Car created successfully!")):n.error((r==null?void 0:r.message)||"Failed to create car")}catch(c){n.error(((l=(a=c.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to create car")}},R=s=>{t.serviceIds.includes(s)?m({...t,serviceIds:t.serviceIds.filter(a=>a!==s)}):m({...t,serviceIds:[...t.serviceIds,s]})},Z=W.filter(s=>t.serviceIds.includes(s._id)),w=Z.length>0?(()=>{const s=Z.reduce((l,c)=>l+(c.maxTime??c.minTime??60),0),a=new Date;return a.setMinutes(a.getMinutes()+s),a})():null,fe=async s=>{var l;const a=s.target.files;if(a!=null&&a.length){if(a.length<2){n.error("Please select at least 2 before images");return}if(a.length>4){n.error("Maximum 4 images allowed");return}X(!0);try{const c=await we(a),r=new FormData;c.forEach(u=>r.append("images",u));const i=await Se(r);(l=i==null?void 0:i.urls)!=null&&l.length?(m(u=>({...u,beforeImages:i.urls})),n.success("Images uploaded")):n.error("Upload failed")}catch(c){n.error((c==null?void 0:c.message)||"Image upload failed")}finally{X(!1)}}},pe=s=>{m({...t,beforeImages:t.beforeImages.filter((a,l)=>l!==s)})},E=s=>{if(!s)return"";const a=new Date(s),l=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),u=String(a.getMinutes()).padStart(2,"0");return`${l}-${c}-${r}T${i}:${u}`},je=async s=>{var c,r,i,u,b;if(s.preventDefault(),!t.customerId||!t.carId||t.serviceIds.length===0){n.error("Please fill all required fields");return}if(!((c=t.beforeImages)!=null&&c.length)||t.beforeImages.length<2){n.error("Please upload at least 2 before images of the car");return}const a={customerId:t.customerId,carId:t.carId,serviceIds:t.serviceIds,beforeImages:t.beforeImages,notes:t.notes||""},l=t.estimatedDelivery||w;l&&(a.estimatedDelivery=new Date(l).toISOString()),t.assignedTo&&(a.assignedTo=t.assignedTo),Y(!0);try{const d=await p.post("/admin/jobs",a);(r=d==null?void 0:d.data)!=null&&r.success?(n.success("Job created successfully!"),te(`${U}/jobs`)):n.error(((i=d==null?void 0:d.data)==null?void 0:i.message)||"Failed to create job")}catch(d){n.error(((b=(u=d.response)==null?void 0:u.data)==null?void 0:b.message)||"Failed to create job")}finally{Y(!1)}};return oe?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(ve,{size:"section"})}):e.jsxs(e.Fragment,{children:[e.jsx(Ie,{show:M,message:"Uploading images…"}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ee,{to:`${U}/jobs`,children:e.jsx(f,{variant:"ghost",size:"icon",children:e.jsx(Ne,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Create New Job"}),e.jsx("p",{className:"text-muted-foreground",children:"Add a new car wash job"})]})]}),e.jsxs("form",{onSubmit:je,onKeyDown:Ce,className:"space-y-6",children:[e.jsxs(v,{children:[e.jsx($,{children:e.jsx(k,{children:"Customer & Car"})}),e.jsxs(F,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Customer *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(q,{value:t.customerId,onValueChange:s=>{m(a=>({...a,customerId:s,carId:""})),C(!1)},children:[e.jsx(B,{className:"flex-1",children:e.jsx(V,{placeholder:"Select customer"})}),e.jsx(z,{children:re.map(s=>e.jsxs(P,{value:s._id,children:[s.name," - ",s.phone]},s._id))})]}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>{G?C(!1):(m(s=>({...s,customerId:"",carId:""})),C(!0))},children:e.jsx(se,{className:"h-4 w-4"})})]}),G&&e.jsxs(v,{className:"p-4 space-y-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"New customer"}),e.jsx(f,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>C(!1),"aria-label":"Close",children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Name *"}),e.jsx(j,{value:y.name,onChange:s=>_({...y,name:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Phone *"}),e.jsx(j,{value:y.phone,onChange:s=>_({...y,phone:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"WhatsApp Number *"}),e.jsx(j,{value:y.whatsappNumber,onChange:s=>_({...y,whatsappNumber:s.target.value}),required:!0})]}),e.jsx(f,{type:"button",onClick:xe,children:"Create Customer"})]})]}),(x==null?void 0:x.role)==="CAR_WASH_ADMIN"&&K.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Assigned to (optional)"}),e.jsxs(q,{value:t.assignedTo,onValueChange:s=>m({...t,assignedTo:s}),children:[e.jsx(B,{className:"flex-1",children:e.jsx(V,{placeholder:"Select employee"})}),e.jsxs(z,{children:[e.jsx(P,{value:"",children:"Unassigned"}),K.map(s=>e.jsxs(P,{value:s._id,children:[s.name||s.email," (",s.employeeCode,")"]},s._id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Car *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(q,{value:t.carId,onValueChange:s=>{m(a=>({...a,carId:s})),I(!1)},disabled:!t.customerId,children:[e.jsx(B,{className:"flex-1",children:e.jsx(V,{placeholder:"Select car"})}),e.jsx(z,{children:ce.map(s=>e.jsxs(P,{value:s._id,children:[s.carNumber," ",s.brand&&s.model&&`- ${s.brand} ${s.model}`]},s._id))})]}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>{Q?I(!1):(m(s=>({...s,carId:""})),I(!0))},disabled:!t.customerId,children:e.jsx(se,{className:"h-4 w-4"})})]}),Q&&e.jsxs(v,{className:"p-4 space-y-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"New car"}),e.jsx(f,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>I(!1),"aria-label":"Close",children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Car Number *"}),e.jsx(j,{value:g.carNumber,onChange:s=>N({...g,carNumber:s.target.value}),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Brand"}),e.jsx(j,{value:g.brand,onChange:s=>N({...g,brand:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Model"}),e.jsx(j,{value:g.model,onChange:s=>N({...g,model:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Color"}),e.jsx(j,{value:g.color,onChange:s=>N({...g,color:s.target.value})})]})]}),e.jsx(f,{type:"button",onClick:ge,children:"Create Car"})]})]})]})]}),e.jsxs(v,{children:[e.jsx($,{children:e.jsx(k,{children:"Services *"})}),e.jsx(F,{children:e.jsx("div",{className:"space-y-2",children:W.map(s=>e.jsxs("div",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer ${t.serviceIds.includes(s._id)?"border-primary bg-primary/5":""}`,onClick:()=>R(s._id),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Te(s.price,ie),(s.minTime!=null||s.maxTime!=null)&&e.jsxs(e.Fragment,{children:[" • ",s.minTime!=null&&s.maxTime!=null?`${s.minTime}-${s.maxTime} min`:s.maxTime!=null?`Up to ${s.maxTime} min`:`${s.minTime} min`]})]})]}),e.jsx("input",{type:"checkbox",checked:t.serviceIds.includes(s._id),onChange:()=>R(s._id),className:"h-4 w-4"})]},s._id))})})]}),e.jsx(v,{children:e.jsxs($,{children:[e.jsx(k,{children:"Estimated delivery (optional to edit)"}),e.jsxs(F,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Calculated from selected services. You can change the date/time before creating the job."}),e.jsx(j,{type:"datetime-local",value:t.estimatedDelivery?E(t.estimatedDelivery):w?E(w):"",onChange:s=>{const a=s.target.value;m({...t,estimatedDelivery:a?new Date(a):null})},min:E(new Date)}),w&&!t.estimatedDelivery&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Suggested: ",w.toLocaleString()," (from service times)"]})]})]})}),e.jsx(v,{children:e.jsxs($,{children:[e.jsx(k,{children:"Before photos (car) *"}),e.jsxs(F,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload at least 2 photos of the car before the job. Max 4."}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:fe,disabled:M,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),M&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),t.beforeImages.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:t.beforeImages.map((s,a)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s,alt:`Before ${a+1}`,className:"h-20 w-20 object-cover rounded border"}),e.jsx("button",{type:"button",onClick:()=>pe(a),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full w-5 h-5 text-xs",children:"×"})]},a))})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(ee,{to:`${U}/jobs`,children:e.jsx(f,{type:"button",variant:"outline",children:"Cancel"})}),e.jsx(f,{type:"submit",disabled:O,children:O?"Creating...":"Create Job"})]})]})]})]})}export{Pe as default};
