import{n as fe,o as ge,r as i,a as f,u as o,j as e,V as pe,k as Z,f as j,A as ye,p as be,C as v,b as $,c as M,e as k,L as u,P as ee,X as se,I as g}from"./index-D5eo3nMI.js";import{M as ve,a as Ne,b as q}from"./MultiImageUpload-Wwfmm4Gr.js";import{u as Ce}from"./usePortalPath-kWBXknMv.js";import{S as J,a as U,b as V,c as B,d as F}from"./select-CN9qpzQy.js";import{f as Ie}from"./currencyUtils-CJd_f-r_.js";function De(){const ae=fe(),E=Ce(),{user:h}=ge(s=>s.auth),[te,z]=i.useState([]),[re,H]=i.useState([]),[O,ce]=i.useState([]),[le,ne]=i.useState("USD"),[ie,oe]=i.useState(!0),[W,G]=i.useState(!1),[a,m]=i.useState({customerId:"",carId:"",serviceIds:[],beforeImages:[],estimatedDelivery:null,notes:"",assignedTo:""}),[X,de]=i.useState([]),[p,D]=i.useState({name:"",phone:"",whatsappNumber:"",email:""}),[x,N]=i.useState({carNumber:"",brand:"",model:"",color:""}),[Y,C]=i.useState(!1),[K,I]=i.useState(!1);i.useEffect(()=>{me()},[h==null?void 0:h.role]),i.useEffect(()=>{a.customerId&&ue(a.customerId)},[a.customerId]);const me=async()=>{var s,t,l,c,r,n,y;try{const b=[f.get("/admin/customers"),f.get("/admin/services"),f.get("/admin/settings").catch(()=>({data:{}}))];(h==null?void 0:h.role)==="CAR_WASH_ADMIN"&&b.push(f.get("/admin/employees").catch(()=>({data:{success:!1,employees:[]}})));const d=await Promise.all(b),w=(s=d[0])==null?void 0:s.data,A=(t=d[1])==null?void 0:t.data,_=(l=d[2])==null?void 0:l.data,T=(c=d[3])==null?void 0:c.data;w!=null&&w.success&&Array.isArray(w.customers)&&z(w.customers),A!=null&&A.success&&Array.isArray(A.services)&&ce(A.services.filter(L=>(L==null?void 0:L.isActive)!==!1)),_!=null&&_.success&&((r=_.settings)!=null&&r.currency)&&ne(_.settings.currency),T!=null&&T.success&&Array.isArray(T.employees)&&de(T.employees)}catch(b){o.error(((y=(n=b.response)==null?void 0:n.data)==null?void 0:y.message)||"Failed to load data")}finally{oe(!1)}},ue=async s=>{var t,l,c;if(s)try{const r=await f.get(`/admin/cars?customerId=${encodeURIComponent(s)}`);(t=r==null?void 0:r.data)!=null&&t.success&&Array.isArray(r.data.cars)&&H(r.data.cars)}catch(r){o.error(((c=(l=r.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to load cars")}},he=async()=>{var s,t,l;try{const c=await f.post("/admin/customers",p),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.customer)!=null&&s._id)?(z(n=>[...n,r.customer]),m(n=>({...n,customerId:r.customer._id})),D({name:"",phone:"",whatsappNumber:"",email:""}),C(!1),o.success("Customer created successfully!")):o.error((r==null?void 0:r.message)||"Failed to create customer")}catch(c){o.error(((l=(t=c.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to create customer")}},xe=async()=>{var s,t,l;if(!a.customerId){o.error("Please select a customer first");return}try{const c=await f.post("/admin/cars",{...x,customerId:a.customerId}),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.car)!=null&&s._id)?(H(n=>[...n,r.car]),m(n=>({...n,carId:r.car._id})),N({carNumber:"",brand:"",model:"",color:""}),I(!1),o.success("Car created successfully!")):o.error((r==null?void 0:r.message)||"Failed to create car")}catch(c){o.error(((l=(t=c.response)==null?void 0:t.data)==null?void 0:l.message)||"Failed to create car")}},Q=s=>{a.serviceIds.includes(s)?m({...a,serviceIds:a.serviceIds.filter(t=>t!==s)}):m({...a,serviceIds:[...a.serviceIds,s]})},R=O.filter(s=>a.serviceIds.includes(s._id)),S=R.length>0?(()=>{const s=R.reduce((l,c)=>l+(c.maxTime??c.minTime??60),0),t=new Date;return t.setMinutes(t.getMinutes()+s),t})():null,P=s=>{if(!s)return"";const t=new Date(s),l=t.getFullYear(),c=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),y=String(t.getMinutes()).padStart(2,"0");return`${l}-${c}-${r}T${n}:${y}`},je=async s=>{var c,r,n,y,b;if(s.preventDefault(),!a.customerId||!a.carId||a.serviceIds.length===0){o.error("Please fill all required fields");return}if(!((c=a.beforeImages)!=null&&c.length)||a.beforeImages.length<q){o.error(`Please upload at least ${q} before images of the car`);return}const t={customerId:a.customerId,carId:a.carId,serviceIds:a.serviceIds,beforeImages:a.beforeImages,notes:a.notes||""},l=a.estimatedDelivery||S;l&&(t.estimatedDelivery=new Date(l).toISOString()),a.assignedTo&&(t.assignedTo=a.assignedTo),G(!0);try{const d=await f.post("/admin/jobs",t);(r=d==null?void 0:d.data)!=null&&r.success?(o.success("Job created successfully!"),ae(`${E}/jobs`)):o.error(((n=d==null?void 0:d.data)==null?void 0:n.message)||"Failed to create job")}catch(d){o.error(((b=(y=d.response)==null?void 0:y.data)==null?void 0:b.message)||"Failed to create job")}finally{G(!1)}};return ie?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(pe,{size:"section"})}):e.jsx(e.Fragment,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Z,{to:`${E}/jobs`,children:e.jsx(j,{variant:"ghost",size:"icon",children:e.jsx(ye,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Create New Job"}),e.jsx("p",{className:"text-muted-foreground",children:"Add a new car wash job"})]})]}),e.jsxs("form",{onSubmit:je,onKeyDown:be,className:"space-y-6",children:[e.jsxs(v,{children:[e.jsx($,{children:e.jsx(M,{children:"Customer & Car"})}),e.jsxs(k,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Customer *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(J,{value:a.customerId,onValueChange:s=>{m(t=>({...t,customerId:s,carId:""})),C(!1)},children:[e.jsx(U,{className:"flex-1",children:e.jsx(V,{placeholder:"Select customer"})}),e.jsx(B,{children:te.map(s=>e.jsxs(F,{value:s._id,children:[s.name," - ",s.phone]},s._id))})]}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>{Y?C(!1):(m(s=>({...s,customerId:"",carId:""})),C(!0))},children:e.jsx(ee,{className:"h-4 w-4"})})]}),Y&&e.jsxs(v,{className:"p-4 space-y-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"New customer"}),e.jsx(j,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>C(!1),"aria-label":"Close",children:e.jsx(se,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Name *"}),e.jsx(g,{value:p.name,onChange:s=>D({...p,name:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Phone *"}),e.jsx(g,{value:p.phone,onChange:s=>D({...p,phone:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"WhatsApp Number *"}),e.jsx(g,{value:p.whatsappNumber,onChange:s=>D({...p,whatsappNumber:s.target.value}),required:!0})]}),e.jsx(j,{type:"button",onClick:he,children:"Create Customer"})]})]}),(h==null?void 0:h.role)==="CAR_WASH_ADMIN"&&X.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Assigned to (optional)"}),e.jsxs(J,{value:a.assignedTo,onValueChange:s=>m({...a,assignedTo:s}),children:[e.jsx(U,{className:"flex-1",children:e.jsx(V,{placeholder:"Select employee"})}),e.jsxs(B,{children:[e.jsx(F,{value:"",children:"Unassigned"}),X.map(s=>e.jsxs(F,{value:s._id,children:[s.name||s.email," (",s.employeeCode,")"]},s._id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Car *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(J,{value:a.carId,onValueChange:s=>{m(t=>({...t,carId:s})),I(!1)},disabled:!a.customerId,children:[e.jsx(U,{className:"flex-1",children:e.jsx(V,{placeholder:"Select car"})}),e.jsx(B,{children:re.map(s=>e.jsxs(F,{value:s._id,children:[s.carNumber," ",s.brand&&s.model&&`- ${s.brand} ${s.model}`]},s._id))})]}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>{K?I(!1):(m(s=>({...s,carId:""})),I(!0))},disabled:!a.customerId,children:e.jsx(ee,{className:"h-4 w-4"})})]}),K&&e.jsxs(v,{className:"p-4 space-y-4 relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-muted-foreground",children:"New car"}),e.jsx(j,{type:"button",variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",onClick:()=>I(!1),"aria-label":"Close",children:e.jsx(se,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Car Number *"}),e.jsx(g,{value:x.carNumber,onChange:s=>N({...x,carNumber:s.target.value}),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Brand"}),e.jsx(g,{value:x.brand,onChange:s=>N({...x,brand:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Model"}),e.jsx(g,{value:x.model,onChange:s=>N({...x,model:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Color"}),e.jsx(g,{value:x.color,onChange:s=>N({...x,color:s.target.value})})]})]}),e.jsx(j,{type:"button",onClick:xe,children:"Create Car"})]})]})]})]}),e.jsxs(v,{children:[e.jsx($,{children:e.jsx(M,{children:"Services *"})}),e.jsx(k,{children:e.jsx("div",{className:"space-y-2",children:O.map(s=>e.jsxs("div",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer ${a.serviceIds.includes(s._id)?"border-primary bg-primary/5":""}`,onClick:()=>Q(s._id),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Ie(s.price,le),(s.minTime!=null||s.maxTime!=null)&&e.jsxs(e.Fragment,{children:[" â€¢ ",s.minTime!=null&&s.maxTime!=null?`${s.minTime}-${s.maxTime} min`:s.maxTime!=null?`Up to ${s.maxTime} min`:`${s.minTime} min`]})]})]}),e.jsx("input",{type:"checkbox",checked:a.serviceIds.includes(s._id),onChange:()=>Q(s._id),className:"h-4 w-4"})]},s._id))})})]}),e.jsx(v,{children:e.jsxs($,{children:[e.jsx(M,{children:"Estimated delivery (optional to edit)"}),e.jsxs(k,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Calculated from selected services. You can change the date/time before creating the job."}),e.jsx(g,{type:"datetime-local",value:a.estimatedDelivery?P(a.estimatedDelivery):S?P(S):"",onChange:s=>{const t=s.target.value;m({...a,estimatedDelivery:t?new Date(t):null})},min:P(new Date)}),S&&!a.estimatedDelivery&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Suggested: ",S.toLocaleString()," (from service times)"]})]})]})}),e.jsx(v,{children:e.jsxs($,{children:[e.jsx(M,{children:"Before photos (car) *"}),e.jsx(k,{className:"pt-0",children:e.jsx(ve,{value:a.beforeImages,onChange:s=>m(t=>({...t,beforeImages:s})),folder:"before",minImages:q,maxImages:Ne,label:"",description:"Upload at least 2 photos of the car before the job. Add one by one from camera or gallery. Max 4."})})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(Z,{to:`${E}/jobs`,children:e.jsx(j,{type:"button",variant:"outline",children:"Cancel"})}),e.jsx(j,{type:"submit",disabled:W,children:W?"Creating...":"Create Job"})]})]})]})})}export{De as default};
