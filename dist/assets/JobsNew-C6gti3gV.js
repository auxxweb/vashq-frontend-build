import{n as je,o as ye,r as o,a as x,u as n,j as e,V as be,k as ee,f as b,A as ve,p as Ne,C as v,b as A,c as _,e as $,L as u,P as se,I as f}from"./index-3RdFwQhj.js";import{u as Ce}from"./uploadImages-gmnmf3Ru.js";import{u as Ie}from"./usePortalPath-CKaWAX-Z.js";import{S as E,a as L,b as U,c as q,d as k}from"./select-CUIkZR0j.js";import{f as Se}from"./currencyUtils-CJd_f-r_.js";function $e(){const ae=je(),F=Ie(),{user:h}=ye(s=>s.auth),[te,B]=o.useState([]),[re,V]=o.useState([]),[H,ce]=o.useState([]),[le,ie]=o.useState("USD"),[ne,oe]=o.useState(!0),[J,W]=o.useState(!1),[t,m]=o.useState({customerId:"",carId:"",serviceIds:[],beforeImages:[],estimatedDelivery:null,notes:"",assignedTo:""}),[z,de]=o.useState([]),[Y,K]=o.useState(!1),[p,T]=o.useState({name:"",phone:"",whatsappNumber:"",email:""}),[g,N]=o.useState({carNumber:"",brand:"",model:"",color:""}),[O,G]=o.useState(!1),[Q,R]=o.useState(!1);o.useEffect(()=>{me()},[h==null?void 0:h.role]),o.useEffect(()=>{t.customerId&&ue(t.customerId)},[t.customerId]);const me=async()=>{var s,a,l,c,r,i,j;try{const y=[x.get("/admin/customers"),x.get("/admin/services"),x.get("/admin/settings").catch(()=>({data:{}}))];(h==null?void 0:h.role)==="CAR_WASH_ADMIN"&&y.push(x.get("/admin/employees").catch(()=>({data:{success:!1,employees:[]}})));const d=await Promise.all(y),I=(s=d[0])==null?void 0:s.data,S=(a=d[1])==null?void 0:a.data,w=(l=d[2])==null?void 0:l.data,D=(c=d[3])==null?void 0:c.data;I!=null&&I.success&&Array.isArray(I.customers)&&B(I.customers),S!=null&&S.success&&Array.isArray(S.services)&&ce(S.services.filter(M=>(M==null?void 0:M.isActive)!==!1)),w!=null&&w.success&&((r=w.settings)!=null&&r.currency)&&ie(w.settings.currency),D!=null&&D.success&&Array.isArray(D.employees)&&de(D.employees)}catch(y){n.error(((j=(i=y.response)==null?void 0:i.data)==null?void 0:j.message)||"Failed to load data")}finally{oe(!1)}},ue=async s=>{var a,l,c;if(s)try{const r=await x.get(`/admin/cars?customerId=${encodeURIComponent(s)}`);(a=r==null?void 0:r.data)!=null&&a.success&&Array.isArray(r.data.cars)&&V(r.data.cars)}catch(r){n.error(((c=(l=r.response)==null?void 0:l.data)==null?void 0:c.message)||"Failed to load cars")}},he=async()=>{var s,a,l;try{const c=await x.post("/admin/customers",p),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.customer)!=null&&s._id)?(B(i=>[...i,r.customer]),m(i=>({...i,customerId:r.customer._id})),T({name:"",phone:"",whatsappNumber:"",email:""}),G(!1),n.success("Customer created successfully!")):n.error((r==null?void 0:r.message)||"Failed to create customer")}catch(c){n.error(((l=(a=c.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to create customer")}},ge=async()=>{var s,a,l;if(!t.customerId){n.error("Please select a customer first");return}try{const c=await x.post("/admin/cars",{...g,customerId:t.customerId}),r=c==null?void 0:c.data;r!=null&&r.success&&((s=r.car)!=null&&s._id)?(V(i=>[...i,r.car]),m(i=>({...i,carId:r.car._id})),N({carNumber:"",brand:"",model:"",color:""}),R(!1),n.success("Car created successfully!")):n.error((r==null?void 0:r.message)||"Failed to create car")}catch(c){n.error(((l=(a=c.response)==null?void 0:a.data)==null?void 0:l.message)||"Failed to create car")}},X=s=>{t.serviceIds.includes(s)?m({...t,serviceIds:t.serviceIds.filter(a=>a!==s)}):m({...t,serviceIds:[...t.serviceIds,s]})},Z=H.filter(s=>t.serviceIds.includes(s._id)),C=Z.length>0?(()=>{const s=Z.reduce((l,c)=>l+(c.maxTime??c.minTime??60),0),a=new Date;return a.setMinutes(a.getMinutes()+s),a})():null,xe=async s=>{var l;const a=s.target.files;if(a!=null&&a.length){if(a.length<2){n.error("Please select at least 2 before images");return}if(a.length>4){n.error("Maximum 4 images allowed");return}K(!0);try{const c=new FormData;for(let i=0;i<a.length;i++)c.append("images",a[i]);const r=await Ce(c);(l=r==null?void 0:r.urls)!=null&&l.length?(m(i=>({...i,beforeImages:r.urls})),n.success("Images uploaded")):n.error("Upload failed")}catch(c){n.error((c==null?void 0:c.message)||"Image upload failed")}finally{K(!1)}}},fe=s=>{m({...t,beforeImages:t.beforeImages.filter((a,l)=>l!==s)})},P=s=>{if(!s)return"";const a=new Date(s),l=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0"),i=String(a.getHours()).padStart(2,"0"),j=String(a.getMinutes()).padStart(2,"0");return`${l}-${c}-${r}T${i}:${j}`},pe=async s=>{var c,r,i,j,y;if(s.preventDefault(),!t.customerId||!t.carId||t.serviceIds.length===0){n.error("Please fill all required fields");return}if(!((c=t.beforeImages)!=null&&c.length)||t.beforeImages.length<2){n.error("Please upload at least 2 before images of the car");return}const a={customerId:t.customerId,carId:t.carId,serviceIds:t.serviceIds,beforeImages:t.beforeImages,notes:t.notes||""},l=t.estimatedDelivery||C;l&&(a.estimatedDelivery=new Date(l).toISOString()),t.assignedTo&&(a.assignedTo=t.assignedTo),W(!0);try{const d=await x.post("/admin/jobs",a);(r=d==null?void 0:d.data)!=null&&r.success?(n.success("Job created successfully!"),ae(`${F}/jobs`)):n.error(((i=d==null?void 0:d.data)==null?void 0:i.message)||"Failed to create job")}catch(d){n.error(((y=(j=d.response)==null?void 0:j.data)==null?void 0:y.message)||"Failed to create job")}finally{W(!1)}};return ne?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(be,{size:"section"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ee,{to:`${F}/jobs`,children:e.jsx(b,{variant:"ghost",size:"icon",children:e.jsx(ve,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Create New Job"}),e.jsx("p",{className:"text-muted-foreground",children:"Add a new car wash job"})]})]}),e.jsxs("form",{onSubmit:pe,onKeyDown:Ne,className:"space-y-6",children:[e.jsxs(v,{children:[e.jsx(A,{children:e.jsx(_,{children:"Customer & Car"})}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Customer *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(E,{value:t.customerId,onValueChange:s=>m({...t,customerId:s,carId:""}),children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Select customer"})}),e.jsx(q,{children:te.map(s=>e.jsxs(k,{value:s._id,children:[s.name," - ",s.phone]},s._id))})]}),e.jsx(b,{type:"button",variant:"outline",onClick:()=>G(!O),children:e.jsx(se,{className:"h-4 w-4"})})]}),O&&e.jsxs(v,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Name *"}),e.jsx(f,{value:p.name,onChange:s=>T({...p,name:s.target.value}),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Phone *"}),e.jsx(f,{value:p.phone,onChange:s=>T({...p,phone:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"WhatsApp Number *"}),e.jsx(f,{value:p.whatsappNumber,onChange:s=>T({...p,whatsappNumber:s.target.value}),required:!0})]}),e.jsx(b,{type:"button",onClick:he,children:"Create Customer"})]})]}),(h==null?void 0:h.role)==="CAR_WASH_ADMIN"&&z.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Assigned to (optional)"}),e.jsxs(E,{value:t.assignedTo,onValueChange:s=>m({...t,assignedTo:s}),children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Select employee"})}),e.jsxs(q,{children:[e.jsx(k,{value:"",children:"Unassigned"}),z.map(s=>e.jsxs(k,{value:s._id,children:[s.name||s.email," (",s.employeeCode,")"]},s._id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Car *"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(E,{value:t.carId,onValueChange:s=>m({...t,carId:s}),disabled:!t.customerId,children:[e.jsx(L,{className:"flex-1",children:e.jsx(U,{placeholder:"Select car"})}),e.jsx(q,{children:re.map(s=>e.jsxs(k,{value:s._id,children:[s.carNumber," ",s.brand&&s.model&&`- ${s.brand} ${s.model}`]},s._id))})]}),e.jsx(b,{type:"button",variant:"outline",onClick:()=>R(!Q),disabled:!t.customerId,children:e.jsx(se,{className:"h-4 w-4"})})]}),Q&&e.jsxs(v,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Car Number *"}),e.jsx(f,{value:g.carNumber,onChange:s=>N({...g,carNumber:s.target.value}),required:!0})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Brand"}),e.jsx(f,{value:g.brand,onChange:s=>N({...g,brand:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Model"}),e.jsx(f,{value:g.model,onChange:s=>N({...g,model:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Color"}),e.jsx(f,{value:g.color,onChange:s=>N({...g,color:s.target.value})})]})]}),e.jsx(b,{type:"button",onClick:ge,children:"Create Car"})]})]})]})]}),e.jsxs(v,{children:[e.jsx(A,{children:e.jsx(_,{children:"Services *"})}),e.jsx($,{children:e.jsx("div",{className:"space-y-2",children:H.map(s=>e.jsxs("div",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer ${t.serviceIds.includes(s._id)?"border-primary bg-primary/5":""}`,onClick:()=>X(s._id),children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Se(s.price,le),(s.minTime!=null||s.maxTime!=null)&&e.jsxs(e.Fragment,{children:[" • ",s.minTime!=null&&s.maxTime!=null?`${s.minTime}-${s.maxTime} min`:s.maxTime!=null?`Up to ${s.maxTime} min`:`${s.minTime} min`]})]})]}),e.jsx("input",{type:"checkbox",checked:t.serviceIds.includes(s._id),onChange:()=>X(s._id),className:"h-4 w-4"})]},s._id))})})]}),e.jsx(v,{children:e.jsxs(A,{children:[e.jsx(_,{children:"Estimated delivery (optional to edit)"}),e.jsxs($,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Calculated from selected services. You can change the date/time before creating the job."}),e.jsx(f,{type:"datetime-local",value:t.estimatedDelivery?P(t.estimatedDelivery):C?P(C):"",onChange:s=>{const a=s.target.value;m({...t,estimatedDelivery:a?new Date(a):null})},min:P(new Date)}),C&&!t.estimatedDelivery&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Suggested: ",C.toLocaleString()," (from service times)"]})]})]})}),e.jsx(v,{children:e.jsxs(A,{children:[e.jsx(_,{children:"Before photos (car) *"}),e.jsxs($,{className:"space-y-2 pt-0",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Upload at least 2 photos of the car before the job. Max 4."}),e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:xe,disabled:Y,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),Y&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),t.beforeImages.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:t.beforeImages.map((s,a)=>e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:s,alt:`Before ${a+1}`,className:"h-20 w-20 object-cover rounded border"}),e.jsx("button",{type:"button",onClick:()=>fe(a),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full w-5 h-5 text-xs",children:"×"})]},a))})]})]})}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(ee,{to:`${F}/jobs`,children:e.jsx(b,{type:"button",variant:"outline",children:"Cancel"})}),e.jsx(b,{type:"submit",disabled:J,children:J?"Creating...":"Create Job"})]})]})]})}export{$e as default};
