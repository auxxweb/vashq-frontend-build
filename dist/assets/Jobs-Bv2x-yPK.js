import{n as ie,o as ne,r as l,a as y,u as n,j as e,V as ce,k as I,f as i,P as q,C as D,e as E,I as oe,l as de}from"./index-BZTLDehx.js";import{u as me}from"./usePortalPath-CsSYngOC.js";import{B as ue}from"./badge-CRUAWryU.js";import{S as xe,a as he,b as ge,c as pe,d as fe}from"./select-BqvIpqbY.js";import{D as je,a as ve,b as Ne,c as be,d as ye,f as De}from"./dialog-CdN4X8z7.js";import{f as Ee}from"./currencyUtils-CJd_f-r_.js";import{S as G}from"./search-DTFLJoLb.js";import{C as Ce}from"./clock-Bjji2JGM.js";import{a as H,C as we}from"./chevron-right-JfKEXuYL.js";import{f as Y}from"./format-B3XKS-z2.js";const Se={RECEIVED:"bg-sky-50 text-sky-700 border border-sky-100",WORK_STARTED:"bg-amber-50 text-amber-700 border border-amber-100",COMPLETED:"bg-emerald-50 text-emerald-700 border border-emerald-100",DELIVERED:"bg-slate-100 text-slate-700 border border-slate-200",CANCELLED:"bg-red-50 text-red-700 border border-red-100"},Le=[{value:"ALL",label:"All Statuses"},{value:"RECEIVED",label:"Received"},{value:"WORK_STARTED",label:"Work Started"},{value:"COMPLETED",label:"Completed"},{value:"DELIVERED",label:"Delivered"},{value:"CANCELLED",label:"Cancelled"}],T=10;function _e(){ie();const C=me(),{user:w}=ne(s=>s.auth),R=(w==null?void 0:w.role)==="EMPLOYEE",[v,Z]=l.useState([]),[M,O]=l.useState(!0),[u,S]=l.useState("ALL"),[x,L]=l.useState(""),[V,A]=l.useState(""),[Q,X]=l.useState("USD"),[o,p]=l.useState(1),[f,ee]=l.useState({total:0,totalPages:0}),[se,N]=l.useState(!1),[J,P]=l.useState(null),[j,b]=l.useState([]),[_,F]=l.useState(!1),[U,z]=l.useState(!1);l.useEffect(()=>{$()},[u,x,o]),l.useEffect(()=>{y.get("/admin/settings").then(s=>{var a,t;(a=s.data)!=null&&a.success&&((t=s.data.settings)!=null&&t.currency)&&X(s.data.settings.currency)}).catch(()=>{})},[]);const $=async()=>{var s,a;O(!0);try{const t=new URLSearchParams;t.set("status",u),t.set("page",String(o)),t.set("limit",String(T)),x.trim()&&t.set("search",x.trim());const r=await y.get(`/admin/jobs?${t.toString()}`);r.data.success?(Z(r.data.jobs||[]),r.data.pagination&&ee({total:r.data.pagination.total,totalPages:r.data.pagination.totalPages})):n.error("Failed to load jobs")}catch(t){n.error(((a=(s=t.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to load jobs")}finally{O(!1)}},W=s=>{s==null||s.preventDefault(),L(V),p(1)},K=s=>{s<1||s>f.totalPages||p(s)},B=async(s,a,t=null)=>{var r,d;try{const c={status:a};t!=null&&t.length&&(c.afterImages=t),(await y.patch(`/admin/jobs/${s}/status`,c)).data.success?(n.success("Job status updated successfully!"),$()):n.error("Failed to update job status")}catch(c){n.error(((d=(r=c.response)==null?void 0:r.data)==null?void 0:d.message)||"Failed to update job status")}},ae=s=>{P(s),b([]),N(!0)},te=async s=>{var t,r,d,c,h;const a=s.target.files;if(!(a!=null&&a.length)||a.length<2){n.error("Please select at least 2 after images");return}if(a.length>4){n.error("Maximum 4 images allowed");return}F(!0);try{const m=new FormData;m.append("folder","after");for(let k=0;k<a.length;k++)m.append("images",a[k]);const g=await y.post("/admin/upload/images",m,{timeout:9e4});(t=g.data)!=null&&t.success&&((d=(r=g.data)==null?void 0:r.urls)!=null&&d.length)?(b(g.data.urls),n.success("Images uploaded")):n.error("Upload failed")}catch(m){n.error(((h=(c=m.response)==null?void 0:c.data)==null?void 0:h.message)||"Image upload failed")}finally{F(!1)}},le=async()=>{if(!J||j.length<2){n.error("Please upload at least 2 after images");return}z(!0);try{await B(J,"DELIVERED",j),N(!1),P(null),b([])}finally{z(!1)}},re=s=>({RECEIVED:"WORK_STARTED",WORK_STARTED:"COMPLETED",COMPLETED:"DELIVERED"})[s];return M?e.jsx("div",{className:"flex justify-center items-center w-full",children:e.jsx(ce,{size:"section"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight text-foreground",children:R?"My Jobs":"Jobs"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:R?"Jobs assigned to you. Create new jobs or manage status and delivery.":"Manage all car wash jobs. Open a job to update status and send WhatsApp messages to the customer."})]}),e.jsx(I,{to:`${C}/jobs/new`,className:"min-h-[44px] flex items-center",children:e.jsxs(i,{className:"w-full sm:w-auto gap-2",children:[e.jsx(q,{className:"h-4 w-4"}),"New Job"]})})]}),e.jsx(D,{children:e.jsx(E,{className:"p-6",children:e.jsxs("form",{onSubmit:W,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-2 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(G,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(oe,{placeholder:"Search by token, customer name, phone, or car number...",value:V,onChange:s=>A(s.target.value),onKeyDown:s=>s.key==="Enter"&&W(s),className:"pl-9"})]}),e.jsx(i,{type:"submit",variant:"secondary",size:"icon",className:"shrink-0 h-10 w-10",title:"Search",children:e.jsx(G,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs(xe,{value:u,onValueChange:s=>{S(s),p(1)},children:[e.jsx(he,{className:"w-[180px]",children:e.jsx(ge,{placeholder:"Status"})}),e.jsx(pe,{children:Le.map(s=>e.jsx(fe,{value:s.value,children:s.label},s.value))})]}),(x||u!=="ALL")&&e.jsx(i,{type:"button",variant:"ghost",size:"sm",onClick:()=>{L(""),A(""),S("ALL"),p(1)},children:"Clear"})]})]})})}),e.jsxs("div",{className:"grid gap-4",children:[v.map(s=>{var t,r,d,c,h;const a=re(s.status);return e.jsx(D,{className:"transition-shadow duration-150",children:e.jsx(E,{className:"p-4 sm:p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Token: ",s.tokenNumber]}),e.jsx(ue,{className:Se[s.status]||"",children:s.status.replace("_"," ")})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx("span",{children:(t=s.carId)==null?void 0:t.carNumber}),((r=s.carId)==null?void 0:r.brand)&&((d=s.carId)==null?void 0:d.model)&&e.jsxs("span",{children:["• ",s.carId.brand," ",s.carId.model]})]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium",children:"Customer:"})," ",(c=s.customerId)==null?void 0:c.name," • ",(h=s.customerId)==null?void 0:h.phone]}),s.assignedTo&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Assigned to: ",s.assignedTo.name||s.assignedTo.email," ",s.assignedTo.employeeCode&&`(${s.assignedTo.employeeCode})`]}),s.estimatedDelivery&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ce,{className:"h-4 w-4"}),e.jsxs("span",{children:["ETA: ",Y(new Date(s.estimatedDelivery),"PPp")]})]}),s.services&&s.services.length>0&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Services: ",s.services.map(m=>{var g;return((g=m.serviceId)==null?void 0:g.name)||"N/A"}).join(", ")]})]}),e.jsxs("div",{className:"sm:text-right space-y-2 flex-shrink-0",children:[e.jsx("div",{className:"text-xl sm:text-2xl font-semibold text-slate-800",children:Ee(Number(s.totalPrice),Q)}),e.jsx("div",{className:"text-sm text-muted-foreground",children:Y(new Date(s.createdAt),"MMM d, yyyy")}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-2",children:[a&&s.status!=="DELIVERED"&&s.status!=="CANCELLED"&&(a==="DELIVERED"?e.jsx(i,{size:"sm",onClick:()=>ae(s._id),children:"Mark as Delivered"}):e.jsxs(i,{size:"sm",onClick:()=>B(s._id,a),children:["Mark as ",a.replace("_"," ")]})),e.jsx(I,{to:`${C}/jobs/${s._id}`,className:"min-h-[40px] flex items-center",children:e.jsxs(i,{size:"sm",variant:"outline",className:"w-full sm:w-auto gap-1",children:[e.jsx(H,{className:"h-4 w-4"}),"View details"]})})]})]})]})})},s._id)}),v.length===0&&!M&&e.jsx(D,{children:e.jsxs(E,{className:"p-12 text-center",children:[e.jsx("p",{className:"text-muted-foreground",children:x||u!=="ALL"?"No jobs match your search or filter.":"No jobs found"}),x||u!=="ALL"?e.jsx(i,{className:"mt-4",variant:"outline",onClick:()=>{L(""),A(""),S("ALL"),p(1)},children:"Clear filters"}):e.jsx(I,{to:`${C}/jobs/new`,children:e.jsxs(i,{className:"mt-4",children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Create First Job"]})})]})})]}),e.jsx(je,{open:se,onOpenChange:s=>{N(s),s||P(null),b([])},children:e.jsxs(ve,{children:[e.jsxs(Ne,{children:[e.jsx(be,{children:"Mark as Delivered"}),e.jsx(ye,{children:"Upload at least 2 after photos of the car. These will be saved with the job and can be shared via WhatsApp."})]}),e.jsx(De,{children:e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/jpg,image/png,image/gif,image/webp,image/bmp,image/svg+xml,image/tiff,image/x-icon,image/heic,image/avif,image/*",multiple:!0,onChange:te,disabled:_,className:"block w-full text-sm text-muted-foreground file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-primary file:text-primary-foreground"}),_&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Uploading…"}),j.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:j.map((s,a)=>e.jsx("img",{src:s,alt:`After ${a+1}`,className:"h-16 w-16 object-cover rounded border"},a))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(i,{variant:"outline",onClick:()=>N(!1),children:"Cancel"}),e.jsx(i,{onClick:le,disabled:j.length<2||U,children:U?"Updating...":"Confirm Delivered"})]})]})})]})}),f.totalPages>1&&e.jsx(D,{children:e.jsx(E,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",v.length===0?0:(o-1)*T+1,"–",(o-1)*T+v.length," of ",f.total," jobs"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>K(o-1),disabled:o<=1,children:[e.jsx(we,{className:"h-4 w-4 mr-1"}),"Previous"]}),e.jsxs("span",{className:"text-sm px-2",children:["Page ",o," of ",f.totalPages]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>K(o+1),disabled:o>=f.totalPages,children:["Next",e.jsx(H,{className:"h-4 w-4 ml-1"})]})]})]})})})]})}export{_e as default};
